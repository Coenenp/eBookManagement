{% extends 'books/base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}Quick Process - Book by Book{% endblock %}

{% block extra_css %}
<style>
    .metadata-card {
        border-left: 3px solid var(--bs-primary);
    }
    .metadata-option {
        padding: 0.5rem;
        margin: 0.25rem 0;
        background: var(--bs-light);
        border-radius: 0.25rem;
        cursor: pointer;
        transition: all 0.2s;
    }
    .metadata-option:hover {
        background: var(--bs-secondary-bg);
    }
    .metadata-option.selected {
        background: var(--bs-primary-bg-subtle);
        border: 2px solid var(--bs-primary);
    }
    .confidence-badge {
        font-size: 0.75rem;
    }
    .cover-option {
        max-width: 200px;
        cursor: pointer;
        border: 3px solid transparent;
        transition: border-color 0.2s;
    }
    .cover-option:hover {
        border-color: var(--bs-primary);
    }
    .cover-option.selected {
        border-color: var(--bs-primary);
        box-shadow: 0 0 10px rgba(var(--bs-primary-rgb), 0.5);
    }
    .duplicate-item {
        background: var(--bs-warning-bg-subtle);
        border-left: 3px solid var(--bs-warning);
        padding: 0.75rem;
        margin: 0.5rem 0;
    }
    .other-file-item {
        padding: 0.5rem;
        background: var(--bs-light);
        margin: 0.25rem 0;
        border-radius: 0.25rem;
    }
    .preview-path {
        background: var(--bs-primary-bg-subtle);
        padding: 0.75rem;
        border-radius: 0.25rem;
        font-family: monospace;
        font-size: 0.9rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-3">
        <div class="col-12">
            <h2><i class="fas fa-fast-forward"></i> Quick Process - Book by Book</h2>
            <p class="text-muted">Process books one at a time: lookup metadata, confirm, rename, and organize.</p>
        </div>
    </div>

    <form method="post" id="quick-process-form">
        {% csrf_token %}
        <input type="hidden" name="book_id" value="{{ book.id }}">
        
        <!-- Current Book Info -->
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-book"></i> Current Book: {{ book.id }}</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-9">
                                <p><strong>Current Path:</strong><br>
                                <code>{{ file_path }}</code></p>
                                
                                {% if final_metadata %}
                                <p><strong>Current Title:</strong> {{ final_metadata.final_title|default:"Not set" }}</p>
                                <p><strong>Current Author:</strong> {{ final_metadata.final_author|default:"Not set" }}</p>
                                <p><strong>Current Series:</strong> {{ final_metadata.final_series|default:"Not set" }}
                                {% if final_metadata.final_series_number %} #{{ final_metadata.final_series_number }}{% endif %}</p>
                                {% endif %}
                            </div>
                            <div class="col-md-3 text-center">
                                {% if covers %}
                                    <img src="{{ covers.0.url }}" alt="Cover" class="img-fluid rounded" style="max-height: 200px;">
                                {% else %}
                                    <div class="bg-secondary text-white p-4 rounded">
                                        <i class="fas fa-book fa-3x"></i>
                                        <p class="mt-2 mb-0">No Cover</p>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-secondary text-white">
                        <h6 class="mb-0">Quick Actions</h6>
                    </div>
                    <div class="card-body">
                        <button type="button" class="btn btn-info btn-sm w-100 mb-2" data-bs-toggle="modal" data-bs-target="#lookupModal">
                            <i class="fas fa-search"></i> Lookup Metadata
                        </button>
                        <button type="submit" name="action" value="confirm" class="btn btn-success btn-sm w-100 mb-2">
                            <i class="fas fa-check"></i> Confirm & Process
                        </button>
                        <button type="submit" name="action" value="skip" class="btn btn-warning btn-sm w-100 mb-2">
                            <i class="fas fa-forward"></i> Skip This Book
                        </button>
                        <button type="submit" name="action" value="delete" class="btn btn-danger btn-sm w-100" 
                                onclick="return confirm('Are you sure you want to delete this book and all its files?');">
                            <i class="fas fa-trash"></i> Delete Book
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Metadata Selection -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card metadata-card">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="fas fa-edit"></i> Select Final Metadata</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- Title -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Title</label>
                                {% for title in titles %}
                                <div class="metadata-option" onclick="selectMetadata('final_title', '{{ title.value|escapejs }}', this)">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span>{{ title.value }}</span>
                                        <div>
                                            <span class="badge bg-secondary confidence-badge">{{ title.source }}</span>
                                            <span class="badge bg-primary confidence-badge">{{ title.confidence }}%</span>
                                        </div>
                                    </div>
                                </div>
                                {% empty %}
                                <p class="text-muted">No titles available</p>
                                {% endfor %}
                                <input type="text" class="form-control mt-2" name="final_title" id="final_title" 
                                       placeholder="Or enter custom title" value="{{ final_metadata.final_title }}">
                            </div>
                            
                            <!-- Author -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Author</label>
                                {% for author in authors %}
                                <div class="metadata-option" onclick="selectMetadata('final_author', '{{ author.value|escapejs }}', this)">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span>{{ author.value }}</span>
                                        <div>
                                            <span class="badge bg-secondary confidence-badge">{{ author.source }}</span>
                                            <span class="badge bg-primary confidence-badge">{{ author.confidence }}%</span>
                                        </div>
                                    </div>
                                </div>
                                {% empty %}
                                <p class="text-muted">No authors available</p>
                                {% endfor %}
                                <input type="text" class="form-control mt-2" name="final_author" id="final_author" 
                                       placeholder="Or enter custom author" value="{{ final_metadata.final_author }}">
                            </div>
                            
                            <!-- Series -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Series</label>
                                {% for series in series_list %}
                                <div class="metadata-option" onclick="selectMetadata('final_series', '{{ series.value|escapejs }}', this); selectMetadata('final_series_number', '{{ series.number|escapejs }}', null);">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span>{{ series.value }} {% if series.number %}#{{ series.number }}{% endif %}</span>
                                        <div>
                                            <span class="badge bg-secondary confidence-badge">{{ series.source }}</span>
                                            <span class="badge bg-primary confidence-badge">{{ series.confidence }}%</span>
                                        </div>
                                    </div>
                                </div>
                                {% empty %}
                                <p class="text-muted">No series available</p>
                                {% endfor %}
                                <div class="row mt-2">
                                    <div class="col-8">
                                        <input type="text" class="form-control" name="final_series" id="final_series" 
                                               placeholder="Or enter custom series" value="{{ final_metadata.final_series }}">
                                    </div>
                                    <div class="col-4">
                                        <input type="text" class="form-control" name="final_series_number" id="final_series_number" 
                                               placeholder="#" value="{{ final_metadata.final_series_number }}">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Publisher -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Publisher</label>
                                {% for publisher in publishers %}
                                <div class="metadata-option" onclick="selectMetadata('final_publisher', '{{ publisher.value|escapejs }}', this)">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span>{{ publisher.value }}</span>
                                        <div>
                                            <span class="badge bg-secondary confidence-badge">{{ publisher.source }}</span>
                                            <span class="badge bg-primary confidence-badge">{{ publisher.confidence }}%</span>
                                        </div>
                                    </div>
                                </div>
                                {% empty %}
                                <p class="text-muted">No publishers available</p>
                                {% endfor %}
                                <input type="text" class="form-control mt-2" name="final_publisher" id="final_publisher" 
                                       placeholder="Or enter custom publisher" value="{{ final_metadata.final_publisher }}">
                            </div>
                            
                            <!-- Genres/Tags -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Genres/Tags</label>
                                {% for genre in genres %}
                                <div class="metadata-option" onclick="toggleGenre('{{ genre.value|escapejs }}', this)">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span>{{ genre.value }}</span>
                                        <div>
                                            <span class="badge bg-secondary confidence-badge">{{ genre.source }}</span>
                                            <span class="badge bg-primary confidence-badge">{{ genre.confidence|floatformat:0 }}%</span>
                                        </div>
                                    </div>
                                </div>
                                {% empty %}
                                <p class="text-muted">No genres available</p>
                                {% endfor %}
                                <input type="text" class="form-control mt-2" name="genres" id="genres" 
                                       placeholder="Selected genres (comma-separated)" readonly>
                            </div>
                        </div>
                        
                        <!-- Additional Metadata -->
                        <div class="row">
                            <div class="col-md-4">
                                <label class="form-label">ISBN</label>
                                <input type="text" class="form-control" name="isbn" value="{{ final_metadata.isbn }}">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Language</label>
                                <input type="text" class="form-control" name="language" value="{{ final_metadata.language }}">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Publication Year</label>
                                <input type="text" class="form-control" name="publication_year" value="{{ final_metadata.publication_year }}">
                            </div>
                        </div>
                        
                        <div class="row mt-3">
                            <div class="col-12">
                                <label class="form-label">Description</label>
                                <textarea class="form-control" name="description" rows="3">{{ final_metadata.description }}</textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cover Selection -->
        {% if covers %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="fas fa-image"></i> Select Covers to Download</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            {% for cover in covers %}
                            <div class="col-md-2 mb-3">
                                <div class="cover-option p-2 rounded" onclick="toggleCover('{{ cover.url }}', this)">
                                    <img src="{{ cover.url }}" alt="Cover {{ forloop.counter }}" class="img-fluid rounded">
                                    <div class="mt-1 text-center">
                                        <small class="badge bg-secondary">{{ cover.source }}</small>
                                        {% if cover.width and cover.height %}
                                        <small class="text-muted d-block">{{ cover.width }}x{{ cover.height }}</small>
                                        {% endif %}
                                    </div>
                                    <input type="checkbox" name="selected_covers" value="{{ cover.url }}" style="display:none;">
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Duplicates Warning -->
        {% if duplicates %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-warning">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0"><i class="fas fa-exclamation-triangle"></i> Duplicate Books Found!</h5>
                    </div>
                    <div class="card-body">
                        <p>The following duplicate books were found. Please choose which copies to keep:</p>
                        
                        {% for dup in duplicates %}
                        <div class="duplicate-item">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="duplicate_ids" value="{{ dup.book.id }}" id="dup{{ dup.book.id }}">
                                <label class="form-check-label" for="dup{{ dup.book.id }}">
                                    <strong>{{ dup.type|upper }}</strong>: {{ dup.reason }}<br>
                                    <code>{{ dup.file_path }}</code>
                                </label>
                            </div>
                        </div>
                        {% endfor %}
                        
                        <div class="mt-3">
                            <label class="form-label fw-bold">Action:</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="duplicate_action" value="keep_this" id="keep_this" checked>
                                <label class="form-check-label" for="keep_this">
                                    Keep this book and delete selected duplicates above
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="duplicate_action" value="keep_existing" id="keep_existing">
                                <label class="form-check-label" for="keep_existing">
                                    Keep existing books and delete this one
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="duplicate_action" value="keep_all" id="keep_all">
                                <label class="form-check-label" for="keep_all">
                                    Keep all copies (no deletion)
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Rename/Move Configuration -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="fas fa-folder-open"></i> Rename & Move Configuration</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Folder Pattern</label>
                                <input type="text" class="form-control" name="folder_pattern" id="folder_pattern" 
                                       value="${author.sortname}" onchange="updatePreview()">
                                <small class="text-muted">Available: ${title}, ${author.sortname}, ${bookseries.title}, ${category}, etc.</small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Filename Pattern</label>
                                <input type="text" class="form-control" name="filename_pattern" id="filename_pattern" 
                                       value="${title}.${ext}" onchange="updatePreview()">
                                <small class="text-muted">Use ${ext} for file extension</small>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-12">
                                <label class="form-label fw-bold">Preview Path:</label>
                                <div class="preview-path" id="preview-path">
                                    <em>Enter patterns above to see preview</em>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" name="include_companions" id="include_companions" checked>
                            <label class="form-check-label" for="include_companions">
                                Include companion files (covers, OPF, etc.)
                            </label>
                        </div>
                        
                        {% if companion_files %}
                        <div class="mt-2">
                            <small class="text-muted">Companion files found: 
                                {% for comp in companion_files %}{{ comp.name }}{% if not forloop.last %}, {% endif %}{% endfor %}
                            </small>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Remaining Files -->
        {% if other_files %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="fas fa-folder"></i> Other Files in Directory ({{ other_files|length }})</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted">What should we do with these remaining files after moving the book?</p>
                        
                        <div class="mb-3" style="max-height: 200px; overflow-y: auto;">
                            {% for file in other_files %}
                            <div class="other-file-item">
                                <i class="fas {% if file.is_ebook %}fa-book{% else %}fa-file{% endif %}"></i>
                                {{ file.name }}
                                <span class="text-muted float-end">{{ file.size|filesizeformat }}</span>
                            </div>
                            {% endfor %}
                        </div>
                        
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="radio" name="remaining_files_action" value="leave" id="leave_files" checked>
                            <label class="form-check-label" for="leave_files">
                                Leave them in the original location
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="radio" name="remaining_files_action" value="delete" id="delete_files">
                            <label class="form-check-label" for="delete_files">
                                Delete all remaining files
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="radio" name="remaining_files_action" value="move" id="move_files">
                            <label class="form-check-label" for="move_files">
                                Move to specific location:
                            </label>
                            <input type="text" class="form-control mt-2" name="remaining_files_target" placeholder="/path/to/destination">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Hidden confidence fields -->
        <input type="hidden" name="final_title_confidence" value="95">
        <input type="hidden" name="final_author_confidence" value="95">
    </form>
</div>

<!-- Metadata Lookup Modal -->
<div class="modal fade" id="lookupModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="book_id" value="{{ book.id }}">
                <input type="hidden" name="action" value="lookup">
                
                <div class="modal-header">
                    <h5 class="modal-title">Lookup External Metadata</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Title</label>
                        <input type="text" class="form-control" name="search_title" value="{{ final_metadata.final_title }}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Author</label>
                        <input type="text" class="form-control" name="search_author" value="{{ final_metadata.final_author }}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ISBN</label>
                        <input type="text" class="form-control" name="search_isbn" value="{{ final_metadata.isbn }}">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Lookup</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'book/js/quick-process.js' %}"></script>
{% endblock %}
