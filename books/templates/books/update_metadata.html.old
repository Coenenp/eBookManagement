{% extends 'books/base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}Update Metadata - {{ book.title }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Header -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3 class="mb-0">
                        <i class="fas fa-edit me-2"></i>Update Final Metadata
                    </h3>
                    <a href="{% url 'books:book_detail' book.pk %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1"></i>Back to Book
                    </a>
                </div>
                <div class="card-body">
                    <h5>{{ book.title }}</h5>
                    <p class="text-muted mb-0">Set the final, authoritative values for this book's metadata.</p>
                </div>
            </div>

            <!-- Form -->
            <div class="card">
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data" id="metadataUpdateForm">
                        {% csrf_token %}
                        
                        {% if form.non_field_errors %}
                            <div class="alert alert-danger">
                                {{ form.non_field_errors }}
                            </div>
                        {% endif %}

                        <!-- Basic Info -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="id_final_title" class="form-label">Title *</label>
                                {% if all_titles %}
                                    <select class="form-select mb-2" id="title_dropdown">
                                        <option value="">Select from existing or enter manually below</option>
                                        {% for title in all_titles %}
                                            <option value="{{ title.title }}">
                                                {{ title.title }} ({{ title.source.name }} - {{ title.confidence|floatformat:2 }})
                                            </option>
                                        {% endfor %}
                                    </select>
                                {% endif %}
                                {{ form.final_title }}
                                {% if form.final_title.errors %}
                                    <div class="text-danger small">{{ form.final_title.errors }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-6">
                                <label for="id_final_author" class="form-label">Author *</label>
                                {% if all_authors %}
                                    <select class="form-select mb-2" id="author_dropdown">
                                        <option value="">Select from existing or enter manually below</option>
                                        {% for author in all_authors %}
                                            <option value="{{ author.author.name }}">
                                                {{ author.author.name }} ({{ author.source.name }} - {{ author.confidence|floatformat:2 }})
                                            </option>
                                        {% endfor %}
                                    </select>
                                {% endif %}
                                {{ form.final_author }}
                                {% if form.final_author.errors %}
                                    <div class="text-danger small">{{ form.final_author.errors }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Series Info -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="id_final_series" class="form-label">Series</label>
                                {% if all_series %}
                                    <select class="form-select mb-2" id="series_dropdown">
                                        <option value="">Select from existing or enter manually below</option>
                                        {% for series in all_series %}
                                            <option value="{{ series.series.name }}" data-number="{{ series.series_number|default:'' }}">
                                                {{ series.series.name }} ({{ series.source.name }} - {{ series.confidence|floatformat:2 }})
                                            </option>
                                        {% endfor %}
                                    </select>
                                {% endif %}
                                {{ form.final_series }}
                                {% if form.final_series.errors %}
                                    <div class="text-danger small">{{ form.final_series.errors }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-6">
                                <label for="id_final_series_number" class="form-label">Series Number</label>
                                {{ form.final_series_number }}
                                {% if form.final_series_number.errors %}
                                    <div class="text-danger small">{{ form.final_series_number.errors }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Additional Fields -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="id_final_publisher" class="form-label">Publisher</label>
                                {% if all_publishers %}
                                    <select class="form-select mb-2" id="publisher_dropdown">
                                        <option value="">Select from existing or enter manually below</option>
                                        {% for pub in all_publishers %}
                                            <option value="{{ pub.publisher.name }}">
                                                {{ pub.publisher.name }} ({{ pub.source.name }} - {{ pub.confidence|floatformat:2 }})
                                            </option>
                                        {% endfor %}
                                    </select>
                                {% endif %}
                                {{ form.final_publisher }}
                                {% if form.final_publisher.errors %}
                                    <div class="text-danger small">{{ form.final_publisher.errors }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-6">
                                <label for="id_language" class="form-label">Language</label>
                                {{ form.language }}
                                {% if form.language.errors %}
                                    <div class="text-danger small">{{ form.language.errors }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="id_isbn" class="form-label">ISBN</label>
                                {% if metadata_by_field.isbn %}
                                    <select class="form-select mb-2" id="isbn_dropdown">
                                        <option value="">Select from existing or enter manually below</option>
                                        {% for meta in metadata_by_field.isbn %}
                                            <option value="{{ meta.field_value }}">
                                                {{ meta.field_value }} ({{ meta.source.name }} - {{ meta.confidence|floatformat:2 }})
                                            </option>
                                        {% endfor %}
                                    </select>
                                {% endif %}
                                {{ form.isbn }}
                                {% if form.isbn.errors %}
                                    <div class="text-danger small">{{ form.isbn.errors }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-6">
                                <label for="id_publication_year" class="form-label">Publication Year</label>
                                {% if metadata_by_field.publication_year %}
                                    <select class="form-select mb-2" id="year_dropdown">
                                        <option value="">Select from existing or enter manually below</option>
                                        {% for meta in metadata_by_field.publication_year %}
                                            <option value="{{ meta.field_value }}">
                                                {{ meta.field_value }} ({{ meta.source.name }} - {{ meta.confidence|floatformat:2 }})
                                            </option>
                                        {% endfor %}
                                    </select>
                                {% endif %}
                                {{ form.publication_year }}
                                {% if form.publication_year.errors %}
                                    <div class="text-danger small">{{ form.publication_year.errors }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Description -->
                        <div class="mb-4">
                            <label for="id_description" class="form-label">Description</label>
                            {% if metadata_by_field.description %}
                                <select class="form-select mb-2" id="description_dropdown">
                                    <option value="">Select from existing or enter manually below</option>
                                    {% for meta in metadata_by_field.description %}
                                        <option value="{{ meta.field_value|escape }}">
                                            {{ meta.field_value|truncatewords:10 }} ({{ meta.source.name }} - {{ meta.confidence|floatformat:2 }})
                                        </option>
                                    {% endfor %}
                                </select>
                            {% endif %}
                            {{ form.description }}
                            {% if form.description.errors %}
                                <div class="text-danger small">{{ form.description.errors }}</div>
                            {% endif %}
                        </div>

                        <!-- Genres -->
                        {% if all_genres %}
                        <div class="mb-4">
                            <label class="form-label">Genres</label>
                            <div class="border rounded p-3 mb-2" style="max-height: 150px; overflow-y: auto;">
                                {% for genre in all_genres %}
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox"
                                               name="final_genres" value="{{ genre.genre.name }}"
                                               id="genre_{{ forloop.counter }}">
                                        <label class="form-check-label" for="genre_{{ forloop.counter }}">
                                            {{ genre.genre.name }}
                                            <small class="text-muted">({{ genre.source.name }} - {{ genre.confidence|floatformat:2 }})</small>
                                        </label>
                                    </div>
                                {% endfor %}
                            </div>
                            {{ form.manual_genres }}
                            <small class="form-text text-muted">Add additional genres manually, separated by commas.</small>
                        </div>
                        {% endif %}

                        <!-- Cover Upload -->
                        <div class="mb-4">
                            <label for="id_new_cover_upload" class="form-label">Upload New Cover</label>
                            {{ form.new_cover_upload }}
                            {% if form.new_cover_upload.errors %}
                                <div class="text-danger small">{{ form.new_cover_upload.errors }}</div>
                            {% endif %}
                        </div>

                        <!-- Review Status -->
                        <div class="mb-4">
                            <div class="form-check">
                                {{ form.is_reviewed }}
                                <label class="form-check-label" for="id_is_reviewed">
                                    Mark as reviewed
                                </label>
                            </div>
                            {% if form.is_reviewed.errors %}
                                <div class="text-danger small">{{ form.is_reviewed.errors }}</div>
                            {% endif %}
                        </div>

                        <!-- Hidden fields -->
                        {{ form.final_cover_path }}
                        {{ form.selected_cover }}

                        <!-- Submit Buttons -->
                        <div class="d-flex justify-content-between">
                            <a href="{% url 'books:book_detail' book.pk %}" class="btn btn-secondary">
                                <i class="fas fa-times me-1"></i>Cancel
                            </a>
                            <div>
                                <button type="submit" name="save_action" value="save" class="btn btn-primary me-2">
                                    <i class="fas fa-save me-1"></i>Save Changes
                                </button>
                                <button type="submit" name="save_action" value="save_and_mark_reviewed" class="btn btn-success">
                                    <i class="fas fa-check me-1"></i>Save & Mark Reviewed
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Sync dropdowns with inputs
    const dropdownPairs = [
        ['title_dropdown', 'id_final_title'],
        ['author_dropdown', 'id_final_author'],
        ['series_dropdown', 'id_final_series'],
        ['publisher_dropdown', 'id_final_publisher'],
        ['isbn_dropdown', 'id_isbn'],
        ['year_dropdown', 'id_publication_year'],
        ['description_dropdown', 'id_description']
    ];

    dropdownPairs.forEach(([dropdownId, inputId]) => {
        const dropdown = document.getElementById(dropdownId);
        const input = document.getElementById(inputId);
        
        if (dropdown && input) {
            dropdown.addEventListener('change', function() {
                if (this.value) {
                    input.value = this.value;
                }
            });
        }
    });

    // Special handling for series with number
    const seriesDropdown = document.getElementById('series_dropdown');
    const seriesNumberInput = document.getElementById('id_final_series_number');
    
    if (seriesDropdown && seriesNumberInput) {
        seriesDropdown.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const seriesNumber = selectedOption.getAttribute('data-number');
            if (seriesNumber) {
                seriesNumberInput.value = seriesNumber;
            }
        });
    }

    // Form submission loading state
    const form = document.getElementById('metadataUpdateForm');
    if (form) {
        form.addEventListener('submit', function() {
            const submitButtons = form.querySelectorAll('button[type="submit"]');
            submitButtons.forEach(btn => {
                btn.disabled = true;
                const icon = btn.querySelector('i');
                if (icon) {
                    icon.className = 'fas fa-spinner fa-spin me-1';
                }
            });
        });
    }
});
</script>
{% endblock %}