{% load static %}
{% load book_extras %}

<!-- Enhanced ebook table that will be populated by JavaScript -->
<div class="enhanced-ebook-list h-100">
    <!-- Loading state -->
    <div id="loading-state" class="text-center p-4 text-muted">
        <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
        <p>Loading ebooks...</p>
    </div>
    
    <!-- Table view (will be populated by JavaScript) -->
    <div id="ebook-table-container" class="d-none">
        <div class="table-responsive">
            <table class="table table-hover table-sm enhanced-table mb-0" id="ebookTable">
                <thead class="table-light sticky-top">
                    <tr>
                        <th scope="col" class="sortable-column" data-sort="title">
                            Title
                            <i class="fas fa-sort ms-1 sort-icon"></i>
                        </th>
                        <th scope="col" class="sortable-column" data-sort="author">
                            Author
                            <i class="fas fa-sort ms-1 sort-icon"></i>
                        </th>
                        <th scope="col" class="sortable-column" data-sort="publisher">
                            Publisher
                            <i class="fas fa-sort ms-1 sort-icon"></i>
                        </th>
                        <th scope="col" class="sortable-column" data-sort="series">
                            Series
                            <i class="fas fa-sort ms-1 sort-icon"></i>
                        </th>
                        <th scope="col" class="sortable-column" data-sort="file_format">
                            Format
                            <i class="fas fa-sort ms-1 sort-icon"></i>
                        </th>
                        <th scope="col" class="sortable-column" data-sort="file_size">
                            Size
                            <i class="fas fa-sort ms-1 sort-icon"></i>
                        </th>
                        <th scope="col" class="sortable-column" data-sort="last_scanned">
                            Last Scanned
                            <i class="fas fa-sort ms-1 sort-icon"></i>
                        </th>
                    </tr>
                </thead>
                <tbody id="ebook-table-body">
                    <!-- Rows will be populated by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Empty state -->
    <div id="empty-state" class="text-center py-5 d-none">
        <div class="empty-state">
            <i class="fas fa-book fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">No ebooks found</h5>
            <p class="text-muted">No ebooks match your current search criteria</p>
            <button type="button" class="btn btn-outline-primary" onclick="clearFilters()">
                <i class="fas fa-filter me-2"></i>Clear Filters
            </button>
        </div>
    </div>
</div>

<script>
// Enhanced ebook list specific JavaScript
function renderEbookRow(ebook) {
    const coverImg = ebook.cover_url ? 
        `<img src="${ebook.cover_url}" alt="Cover" class="list-cover">` :
        `<div class="list-cover-placeholder"><i class="fas fa-book"></i></div>`;
    
    const seriesText = ebook.series_name ? 
        `${escapeHtml(ebook.series_name)}${ebook.series_position ? ` #${ebook.series_position}` : ''}` : 
        '-';
    
    return `
        <tr class="enhanced-row list-item" 
            data-id="${ebook.id}" 
            onclick="selectEbook(${ebook.id})"
            ondblclick="onItemActivate(${ebook.id})"
            role="button"
            tabindex="0"
            aria-label="Select ebook ${escapeHtml(ebook.title)}">
            
            <td class="align-middle">
                <div class="d-flex align-items-center">
                    <div class="me-2">
                        ${coverImg}
                    </div>
                    <div class="book-info">
                        <div class="book-title fw-semibold text-truncate">${escapeHtml(ebook.title || 'Unknown Title')}</div>
                        ${ebook.subtitle ? `<div class="book-subtitle text-muted small text-truncate">${escapeHtml(ebook.subtitle)}</div>` : ''}
                    </div>
                </div>
            </td>
            
            <td class="align-middle">
                <span class="fw-medium">${escapeHtml(ebook.author || 'Unknown Author')}</span>
            </td>
            
            <td class="align-middle">
                <span>${escapeHtml(ebook.publisher || '-')}</span>
            </td>
            
            <td class="align-middle">
                <span>${seriesText}</span>
            </td>
            
            <td class="align-middle">
                <span class="badge bg-primary">${ebook.file_format ? ebook.file_format.toUpperCase() : 'UNKNOWN'}</span>
            </td>
            
            <td class="align-middle">
                <span>${formatFileSize(ebook.file_size)}</span>
            </td>
            
            <td class="align-middle">
                <span class="text-muted small">${ebook.last_scanned ? formatDate(ebook.last_scanned) : 'Never'}</span>
            </td>
        </tr>
    `;
}

function populateEbookTable(ebooks) {
    const tableContainer = document.getElementById('ebook-table-container');
    const tableBody = document.getElementById('ebook-table-body');
    const loadingState = document.getElementById('loading-state');
    const emptyState = document.getElementById('empty-state');
    
    // Hide loading state
    if (loadingState) {
        loadingState.classList.add('d-none');
    }
    
    if (ebooks && ebooks.length > 0) {
        // Show table and populate with data
        tableContainer.classList.remove('d-none');
        emptyState.classList.add('d-none');
        
        tableBody.innerHTML = ebooks.map(ebook => renderEbookRow(ebook)).join('');
        
        // Initialize table sorting
        initializeTableSorting();
    } else {
        // Show empty state
        tableContainer.classList.add('d-none');
        emptyState.classList.remove('d-none');
    }
}

function initializeTableSorting() {
    const sortColumns = document.querySelectorAll('.sortable-column');
    sortColumns.forEach(column => {
        column.addEventListener('click', function() {
            const sortField = this.dataset.sort;
            sortEbookTable(sortField);
        });
    });
}

function sortEbookTable(field) {
    // This will be implemented to sort the current filtered data
    if (typeof filteredEbooks !== 'undefined' && filteredEbooks.length > 0) {
        const sortedEbooks = [...filteredEbooks].sort((a, b) => {
            let aVal = a[field] || '';
            let bVal = b[field] || '';
            
            // Handle special cases
            if (field === 'file_size') {
                aVal = parseInt(aVal) || 0;
                bVal = parseInt(bVal) || 0;
                return bVal - aVal; // Descending for file size
            }
            
            if (field === 'last_scanned') {
                aVal = new Date(aVal || 0);
                bVal = new Date(bVal || 0);
                return bVal - aVal; // Descending for dates
            }
            
            // String comparison
            return aVal.toString().toLowerCase().localeCompare(bVal.toString().toLowerCase());
        });
        
        populateEbookTable(sortedEbooks);
        
        // Update sort indicators
        document.querySelectorAll('.sort-icon').forEach(icon => {
            icon.className = 'fas fa-sort ms-1 sort-icon';
        });
        const activeSort = document.querySelector(`[data-sort="${field}"] .sort-icon`);
        if (activeSort) {
            activeSort.className = 'fas fa-sort-up ms-1 sort-icon';
        }
    }
}

function clearFilters() {
    const searchFilter = document.getElementById('search-filter');
    const formatFilter = document.getElementById('format-filter');
    const sortFilter = document.getElementById('sort-filter');
    
    if (searchFilter) searchFilter.value = '';
    if (formatFilter) formatFilter.value = '';
    if (sortFilter) sortFilter.value = 'title';
    
    // Reload data
    if (typeof customLoadItems === 'function') {
        customLoadItems();
    }
}

// Helper function for selecting ebooks
function selectEbook(ebookId) {
    // Remove selection from all rows
    document.querySelectorAll('.list-item').forEach(row => {
        row.classList.remove('selected');
    });
    
    // Add selection to clicked row
    const row = document.querySelector(`[data-id="${ebookId}"]`);
    if (row) {
        row.classList.add('selected');
    }
    
    // Load ebook details
    if (typeof customLoadDetail === 'function') {
        customLoadDetail(ebookId);
    }
}

// Global function to render ebooks list (called from main JavaScript)
function renderEbooksList(ebooks) {
    window.filteredEbooks = ebooks; // Store for sorting
    populateEbookTable(ebooks);
    updateItemCount(ebooks.length);
}
</script>