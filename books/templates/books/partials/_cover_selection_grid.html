{% load static %}
{# Enhanced cover selection grid with radio buttons for final selection and checkboxes for downloading #}

{% if all_covers %}
<div class="card">
    <div class="card-header bg-light">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h5 class="mb-0"><i class="fas fa-images"></i> Cover Selection</h5>
                <small class="text-muted">Choose final cover (radio) • Download multiple (checkboxes)</small>
            </div>
            <span class="badge bg-info">{{ all_covers|length }} available</span>
        </div>
    </div>
    <div class="card-body">
        <!-- EPUB Options -->
        {% if book.file_format == 'epub' %}
        <div class="alert alert-info mb-3">
            <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" name="remove_unused_epub_images" 
                               id="remove_unused_epub_images" value="true">
                        <label class="form-check-label" for="remove_unused_epub_images">
                            <i class="fas fa-broom me-1"></i>
                            <strong>Remove unused images from EPUB</strong> when embedding metadata
                            <small class="d-block text-muted">Keeps only the selected final cover, removes orphaned images</small>
                        </label>
                    </div>
                </div>
                <div class="ms-3">
                    <button type="button" class="btn btn-sm btn-outline-primary" 
                            onclick="openMultiCoverSelector({{ book.id }})">
                        <i class="fas fa-images me-1"></i>
                        View All Internal Images
                    </button>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Cover Grid -->
        <div class="row">
            {% for cover in all_covers %}
            <div class="col-md-3 col-lg-2 mb-3">
                <div class="cover-option-wrapper">
                    <div class="cover-option p-2 rounded border {% if cover.is_final %}border-success border-3{% endif %}" 
                         data-cover-path="{{ cover.path }}">
                        <!-- Cover Image -->
                        <img src="{{ cover.url }}" alt="Cover from {{ cover.source_label }}" 
                             class="img-fluid rounded" 
                             onerror="this.src='{% static "books/images/no-cover.png" %}'">
                        
                        <!-- Cover Info -->
                        <div class="mt-2 text-center">
                            <!-- Source Badge -->
                            <span class="badge {{ cover.source_badge_class }} mb-1">
                                <i class="fas {{ cover.source_icon }}"></i> {{ cover.source_label }}
                            </span>
                            
                            <!-- Dimensions -->
                            {% if cover.width and cover.height %}
                            <small class="text-muted d-block">{{ cover.width }}×{{ cover.height }}px</small>
                            {% endif %}
                            
                            <!-- Quality Score -->
                            {% if cover.quality_score %}
                            <span class="badge {% if cover.quality_score >= 80 %}bg-success{% elif cover.quality_score >= 50 %}bg-warning text-dark{% else %}bg-danger{% endif %} mb-1">
                                <i class="fas fa-star"></i> {{ cover.quality_score }}
                            </span>
                            {% endif %}
                            
                            <!-- Confidence -->
                            {% if cover.confidence %}
                            <span class="badge {% if cover.confidence >= 0.8 %}bg-success{% elif cover.confidence >= 0.5 %}bg-warning text-dark{% else %}bg-danger{% endif %}">
                                {{ cover.confidence|floatformat:2 }}
                            </span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Selection Controls -->
                    <div class="mt-2">
                        <!-- Radio: Select as Final Cover -->
                        <div class="form-check">
                            <input class="form-check-input cover-final-radio" 
                                   type="radio" 
                                   name="final_cover_path" 
                                   value="{{ cover.path }}" 
                                   id="final_{{ forloop.counter }}"
                                   {% if cover.is_final %}checked{% endif %}
                                   onchange="updateCoverSelection(this)">
                            <label class="form-check-label small fw-bold text-success" for="final_{{ forloop.counter }}">
                                <i class="fas fa-check-circle"></i> Use as Final
                            </label>
                        </div>
                        
                        <!-- Checkbox: Download (only for external/API covers) -->
                        {% if cover.can_download %}
                        <div class="form-check">
                            <input class="form-check-input cover-download-checkbox" 
                                   type="checkbox" 
                                   name="selected_covers" 
                                   value="{{ cover.id }}" 
                                   id="download_{{ forloop.counter }}"
                                   {% if cover.is_downloaded %}checked{% endif %}>
                            <label class="form-check-label small" for="download_{{ forloop.counter }}">
                                <i class="fas fa-download"></i> Download
                            </label>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <!-- Action Buttons -->
        <div class="mt-3 d-flex gap-2">
            <button type="button" class="btn btn-primary" onclick="downloadSelectedCovers()">
                <i class="fas fa-download me-1"></i>Download Selected Covers
            </button>
            <button type="button" class="btn btn-outline-secondary" onclick="selectAllDownloads()">
                Select All for Download
            </button>
            <button type="button" class="btn btn-outline-secondary" onclick="deselectAllDownloads()">
                Deselect All Downloads
            </button>
        </div>
    </div>
</div>
{% else %}
<div class="alert alert-info">
    <i class="fas fa-info-circle me-2"></i>No covers available. Use the Rescan button to fetch covers from external sources.
</div>
{% endif %}

<style>
.cover-option {
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
}
.cover-option:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}
.cover-option.selected-final {
    border-color: var(--bs-success) !important;
    box-shadow: 0 0 15px rgba(25, 135, 84, 0.4);
}
.cover-option img {
    max-height: 200px;
    object-fit: contain;
}
.cover-option-wrapper {
    position: relative;
}
.border-success.border-3 {
    box-shadow: 0 0 20px rgba(25, 135, 84, 0.6);
}
</style>
