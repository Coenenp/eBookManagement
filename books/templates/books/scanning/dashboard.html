{% extends "books/base.html" %}
{% load static %}
{% load custom_filters %}

{% block title %}Scanning Dashboard{% endblock %}

{% block extra_css %}
<!-- Scanning dashboard styles already included in dashboard.css -->
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h1><i class="fas fa-cogs me-2"></i>Scanning Dashboard</h1>
            <p class="text-muted">Monitor background scanning operations and API status</p>
        </div>
        <div class="col-auto">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newScanModal">
                <i class="fas fa-plus me-2"></i>Start New Scan
            </button>
        </div>
    </div>

    <!-- API Status Cards -->
    <div class="row mb-4">
        <div class="col-12">
            <h3>API Status</h3>
        </div>
        {% for api_name, api_info in api_status.items %}
        <div class="col-md-4 mb-3">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">
                        <span class="api-status-indicator {% if api_info.healthy %}api-healthy{% else %}api-down{% endif %}"></span>
                        {{ api_info.api_name }}
                    </h5>
                    
                    {% if api_info.rate_limits.limits %}
                    <div class="mt-2">
                        {% for period, limit in api_info.rate_limits.limits.items %}
                            {% with count=api_info.rate_limits.current_counts|lookup:period|default:0 %}
                            <div class="mb-2">
                                <small class="text-muted">{{ period|title }}:</small>
                                <div class="progress progress-thin">
                                    <div class="progress-bar api-rate-progress" 
                                         data-width="{% if limit %}{{ count|mul:100|div:limit }}{% else %}0{% endif %}"
                                         title="{{ count }}/{{ limit }}">
                                    </div>
                                </div>
                                <small>{{ count }}/{{ limit }}</small>
                            </div>
                            {% endwith %}
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Active Scans -->
    <div class="row mb-4">
        <div class="col-12">
            <h3>Active Scans</h3>
        </div>
        <div class="col-12" id="active-scans-container">
            {% if active_scans %}
                {% for scan in active_scans %}
                <div class="card scan-card mb-3" data-job-id="{{ scan.job_id }}">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h5 class="card-title mb-1">{{ scan.status|default:"Scanning" }}</h5>
                                <p class="card-text text-muted mb-2">
                                    Job ID: <code>{{ scan.job_id }}</code>
                                </p>
                                <div class="progress mb-2">
                                    <div class="progress-bar scan-progress-bar" 
                                         data-width="{{ scan.percentage|default:0 }}">
                                        {{ scan.percentage|default:0 }}%
                                    </div>
                                </div>
                                <small class="text-muted scan-details">{{ scan.details|default:"Processing..." }}</small>
                            </div>
                            <div class="col-md-4 text-end">
                                <button class="btn btn-outline-danger btn-sm cancel-scan-btn" 
                                        data-job-id="{{ scan.job_id }}">
                                    <i class="fas fa-stop me-1"></i>Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    No active scan jobs. Use the "Start New Scan" button to begin scanning.
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Recent Folders -->
    <div class="row">
        <div class="col-12">
            <h3>Recent Scan Folders</h3>
        </div>
        <div class="col-12">
            {% if recent_folders %}
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Path</th>
                                <th>Content Type</th>
                                <th>Language</th>
                                <th>Books</th>
                                <th>Last Scanned</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for folder in recent_folders %}
                            <tr>
                                <td>{{ folder.name }}</td>
                                <td><code>{{ folder.path }}</code></td>
                                <td>
                                    <span class="badge 
                                        {% if folder.content_type == 'ebooks' %}bg-primary
                                        {% elif folder.content_type == 'comics' %}bg-warning
                                        {% elif folder.content_type == 'audiobooks' %}bg-info
                                        {% elif folder.content_type == 'mixed' %}bg-secondary
                                        {% else %}bg-light text-dark{% endif %}">
                                        {{ folder.get_content_type_display }}
                                    </span>
                                </td>
                                <td>{{ folder.language|upper }}</td>
                                <td>{{ folder.book_count }}</td>
                                <td>
                                    {% if folder.last_scanned %}
                                        {{ folder.last_scanned|timesince }} ago
                                    {% else %}
                                        Never
                                    {% endif %}
                                </td>
                                <td>
                                    <button class="btn btn-outline-primary btn-sm rescan-folder-btn" 
                                            data-folder-id="{{ folder.id }}" 
                                            data-folder-name="{{ folder.name }}">
                                        <i class="fas fa-redo me-1"></i>Rescan
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    No scan folders found. Start your first scan to see folders here.
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- New Scan Modal -->
<div class="modal fade" id="newScanModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Start New Scan</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Tabs for different scan types -->
                <ul class="nav nav-tabs" id="scanTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="folder-scan-tab" data-bs-toggle="tab" 
                                data-bs-target="#folder-scan" type="button" role="tab">
                            <i class="fas fa-folder me-2"></i>Scan Folder
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="book-rescan-tab" data-bs-toggle="tab" 
                                data-bs-target="#book-rescan" type="button" role="tab">
                            <i class="fas fa-redo me-2"></i>Rescan Books
                        </button>
                    </li>
                </ul>

                <div class="tab-content mt-3" id="scanTabContent">
                    <!-- Folder Scan Tab -->
                    <div class="tab-pane fade show active" id="folder-scan" role="tabpanel">
                        <form method="post" action="{% url 'books:start_folder_scan' %}">
                            {% csrf_token %}
                            <div class="mb-3">
                                <label for="folder_path" class="form-label">Folder Path</label>
                                <input type="text" class="form-control" id="folder_path" name="folder_path" 
                                       placeholder="/path/to/books" required>
                                <div class="form-text">Full path to the folder containing book files</div>
                            </div>
                            <div class="mb-3">
                                <label for="content_type" class="form-label">Content Type</label>
                                <select class="form-control" id="content_type" name="content_type">
                                    <option value="ebooks">Ebooks</option>
                                    <option value="comics">Comics</option>
                                    <option value="audiobooks">Audiobooks</option>
                                    <option value="mixed">Mixed Content</option>
                                </select>
                                <div class="form-text">Type of content in this folder</div>
                            </div>
                            <div class="mb-3">
                                <label for="language" class="form-label">Default Language</label>
                                <select class="form-control" id="language" name="language">
                                    <option value="en">English</option>
                                    <option value="fr">French</option>
                                    <option value="de">German</option>
                                    <option value="es">Spanish</option>
                                    <option value="it">Italian</option>
                                    <option value="nl">Dutch</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="enable_external_apis" 
                                           name="enable_external_apis" checked>
                                    <label class="form-check-label" for="enable_external_apis">
                                        Query external APIs for metadata
                                    </label>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="submit" class="btn btn-primary">Start Scan</button>
                            </div>
                        </form>
                    </div>

                    <!-- Book Rescan Tab -->
                    <div class="tab-pane fade" id="book-rescan" role="tabpanel">
                        <form method="post" action="{% url 'books:start_book_rescan' %}">
                            {% csrf_token %}
                            <div class="mb-3">
                                <label class="form-label">Rescan Options</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="rescan_type" 
                                           id="rescan_all" value="all">
                                    <label class="form-check-label" for="rescan_all">
                                        Rescan all books
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="rescan_type" 
                                           id="rescan_folder" value="folder" checked>
                                    <label class="form-check-label" for="rescan_folder">
                                        Rescan books in folder
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="rescan_type" 
                                           id="rescan_specific" value="specific">
                                    <label class="form-check-label" for="rescan_specific">
                                        Rescan specific books (enter IDs)
                                    </label>
                                </div>
                            </div>
                            
                            <div class="mb-3" id="folder-select-group">
                                <label for="folder_id" class="form-label">Select Folder</label>
                                <select class="form-control" id="folder_id" name="folder_id">
                                    {% for folder in recent_folders %}
                                    <option value="{{ folder.id }}">{{ folder.name }} ({{ folder.book_count }} book{{ folder.book_count|pluralize }})</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="mb-3 hidden-group" id="book-ids-group">
                                <label for="book_ids" class="form-label">Book IDs</label>
                                <input type="text" class="form-control" id="book_ids" name="book_ids" 
                                       placeholder="1,2,3,4">
                                <div class="form-text">Comma-separated list of book IDs</div>
                            </div>
                            
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="enable_external_apis_rescan" 
                                           name="enable_external_apis" checked>
                                    <label class="form-check-label" for="enable_external_apis_rescan">
                                        Query external APIs for updated metadata
                                    </label>
                                </div>
                            </div>
                            
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="submit" class="btn btn-primary">Start Rescan</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize progress bars from data attributes
    initializeProgressBars();
    
    // Auto-refresh active scans every 5 seconds
    setInterval(updateActiveScans, 5000);
    
    // Auto-refresh API status every 30 seconds
    setInterval(updateAPIStatus, 30000);
    
    // Handle rescan type changes
    document.querySelectorAll('input[name="rescan_type"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const folderGroup = document.getElementById('folder-select-group');
            const bookIdsGroup = document.getElementById('book-ids-group');
            
            if (this.value === 'folder') {
                folderGroup.classList.remove('hidden-group');
                bookIdsGroup.classList.add('hidden-group');
            } else if (this.value === 'specific') {
                folderGroup.classList.add('hidden-group');
                bookIdsGroup.classList.remove('hidden-group');
            } else {
                folderGroup.classList.add('hidden-group');
                bookIdsGroup.classList.add('hidden-group');
            }
        });
    });
    
    // Handle cancel scan buttons
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('cancel-scan-btn') || e.target.closest('.cancel-scan-btn')) {
            const btn = e.target.classList.contains('cancel-scan-btn') ? e.target : e.target.closest('.cancel-scan-btn');
            const jobId = btn.getAttribute('data-job-id');
            
            if (confirm('Are you sure you want to cancel this scan?')) {
                cancelScan(jobId);
            }
        }
    });
});

function initializeProgressBars() {
    // Set width for API rate progress bars
    document.querySelectorAll('.api-rate-progress').forEach(progressBar => {
        const width = progressBar.getAttribute('data-width');
        if (width !== null) {
            progressBar.style.width = width + '%';
        }
    });
    
    // Set width for scan progress bars
    document.querySelectorAll('.scan-progress-bar').forEach(progressBar => {
        const width = progressBar.getAttribute('data-width');
        if (width !== null) {
            progressBar.style.width = width + '%';
        }
    });
}

function updateActiveScans() {
    fetch('{% url "books:active_scans_ajax" %}')
        .then(response => response.json())
        .then(data => {
            // Update scan progress for each active scan
            data.scans.forEach(scan => {
                updateScanProgress(scan.job_id);
            });
        })
        .catch(error => console.error('Error updating active scans:', error));
}

function updateScanProgress(jobId) {
    fetch(`{% url 'books:scan_progress_ajax' job_id='PLACEHOLDER' %}`.replace('PLACEHOLDER', jobId))
        .then(response => response.json())
        .then(data => {
            const scanCard = document.querySelector(`[data-job-id="${jobId}"]`);
            if (!scanCard) return;
            
            // Update progress bar
            const progressBar = scanCard.querySelector('.scan-progress-bar');
            if (progressBar) {
                progressBar.style.width = `${data.percentage || 0}%`;
                progressBar.textContent = `${data.percentage || 0}%`;
            }
            
            // Update status and details
            const titleElement = scanCard.querySelector('.card-title');
            const detailsElement = scanCard.querySelector('.scan-details');
            
            if (titleElement) {
                titleElement.textContent = data.status || 'Scanning';
            }
            
            if (detailsElement) {
                detailsElement.textContent = data.details || 'Processing...';
            }
            
            // Handle completion
            if (data.completed) {
                scanCard.classList.add(data.success ? 'completed' : 'error');
                
                // Remove cancel button
                const cancelBtn = scanCard.querySelector('.cancel-scan-btn');
                if (cancelBtn) {
                    cancelBtn.remove();
                }
                
                // Show completion message
                if (detailsElement) {
                    detailsElement.textContent = data.success ? data.message : data.error;
                }
                
                // Auto-remove completed scans after 30 seconds
                setTimeout(() => {
                    scanCard.remove();
                }, 30000);
            }
        })
        .catch(error => console.error('Error updating scan progress:', error));
}

function updateAPIStatus() {
    fetch('{% url "books:api_status_ajax" %}')
        .then(response => response.json())
        .then(data => {
            // Update API status indicators and progress bars
            // This would update the API status cards
            console.log('Updated API status:', data);
        })
        .catch(error => console.error('Error updating API status:', error));
}

function cancelScan(jobId) {
    fetch(`{% url 'books:cancel_scan_ajax' job_id='PLACEHOLDER' %}`.replace('PLACEHOLDER', jobId), {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Remove the scan card
            const scanCard = document.querySelector(`[data-job-id="${jobId}"]`);
            if (scanCard) {
                scanCard.remove();
            }
        } else {
            alert('Failed to cancel scan: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error canceling scan:', error);
        alert('Failed to cancel scan');
    });
}
</script>
{% endblock %}