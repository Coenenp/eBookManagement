{% extends 'books/wizard/base.html' %}

{% block wizard_content %}
<div class="mb-4">
    <h3>
        <i class="fas fa-tags text-primary me-2"></i>
        Assign Content Types
    </h3>
    <p class="text-muted">
        Tell us what type of content each folder contains. This helps organize your library 
        and apply the right scanning and metadata strategies.
    </p>
</div>

<form method="post">
    {% csrf_token %}
    
    {% for folder in folder_analysis %}
    <div class="content-type-assignment">
        <div class="d-flex justify-content-between align-items-start mb-3">
            <div class="flex-grow-1">
                <h5 class="mb-1">
                    <i class="fas fa-folder text-warning me-2"></i>
                    {{ folder.name }}
                </h5>
                <div class="folder-path">{{ folder.path }}</div>
            </div>
            
            <div class="ms-3">
                <select class="form-select" name="folder_{{ folder.path|hash }}" 
                        id="folder_{{ forloop.counter }}">
                    {% for choice_value, choice_display in content_type_choices %}
                    <option value="{{ choice_value }}" 
                            {% if choice_value == folder.suggested_type %}selected{% endif %}>
                        {{ choice_display }}
                    </option>
                    {% endfor %}
                </select>
            </div>
        </div>
        
        <!-- Content Analysis -->
        <div class="content-analysis">
            <div class="analysis-item">
                <span class="analysis-count">{{ folder.analysis.epub_count }}</span>
                <div class="analysis-label">üìö Ebooks</div>
            </div>
            <div class="analysis-item">
                <span class="analysis-count">{{ folder.analysis.pdf_count }}</span>
                <div class="analysis-label">üìÑ PDFs</div>
            </div>
            <div class="analysis-item">
                <span class="analysis-count">{{ folder.analysis.comic_count }}</span>
                <div class="analysis-label">üñºÔ∏è Comics</div>
            </div>
            <div class="analysis-item">
                <span class="analysis-count">{{ folder.analysis.audio_count }}</span>
                <div class="analysis-label">üîä Audio</div>
            </div>
            <div class="analysis-item">
                <span class="analysis-count">{{ folder.analysis.total_files }}</span>
                <div class="analysis-label">üìÅ Total</div>
            </div>
        </div>
        
        <!-- Suggestion Badge -->
        <div class="mt-3">
            <span class="badge bg-info">
                <i class="fas fa-lightbulb me-1"></i>
                Suggested: {{ folder.analysis.suggested_type|capfirst }}
            </span>
            {% if folder.analysis.suggested_type == 'comics' %}
                <small class="text-muted ms-2">
                    High comic file ratio detected
                </small>
            {% elif folder.analysis.suggested_type == 'audiobooks' %}
                <small class="text-muted ms-2">
                    Audio files detected
                </small>
            {% else %}
                <small class="text-muted ms-2">
                    Standard ebook collection
                </small>
            {% endif %}
        </div>
        
        <div class="content-type-preview mt-2 text-muted small">
            Will scan as: <span class="fw-bold">{{ folder.suggested_type|title }}</span>
        </div>
    </div>
    {% empty %}
    <div class="alert alert-warning">
        <div class="d-flex">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <div>
                <strong>No folders selected</strong>
                <p class="mb-0 mt-1">
                    You need to select at least one folder in the previous step.
                    <a href="{% url 'books:wizard_step' step='folders' %}" class="alert-link">
                        Go back to folder selection
                    </a>
                </p>
            </div>
        </div>
    </div>
    {% endfor %}
    
    <!-- Content Type Information -->
    <div class="mt-4">
        <div class="alert alert-info">
            <h6 class="alert-heading">
                <i class="fas fa-info-circle me-2"></i>
                Content Type Guide
            </h6>
            <div class="row">
                <div class="col-md-4">
                    <strong>üìò Ebooks</strong>
                    <ul class="small mb-0 mt-1">
                        <li>Digital books and novels</li>
                        <li>Educational materials</li>
                        <li>Technical documentation</li>
                        <li>General PDF documents</li>
                    </ul>
                </div>
                <div class="col-md-4">
                    <strong>üñºÔ∏è Comics</strong>
                    <ul class="small mb-0 mt-1">
                        <li>Comic books and graphic novels</li>
                        <li>Manga and webcomics</li>
                        <li>Comic archives (CBR/CBZ)</li>
                        <li>Illustrated PDFs</li>
                    </ul>
                </div>
                <div class="col-md-4">
                    <strong>üîä Audiobooks</strong>
                    <ul class="small mb-0 mt-1">
                        <li>Narrated books and stories</li>
                        <li>Podcasts and audio series</li>
                        <li>Language learning audio</li>
                        <li>Audio drama and fiction</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div class="wizard-navigation">
        <div>
            <a href="{% url 'books:wizard_step' step='folders' %}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>
                Back
            </a>
        </div>
        
        <div>
            {% if folder_analysis %}
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-arrow-right me-2"></i>
                Continue
            </button>
            {% endif %}
        </div>
    </div>
</form>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Update preview when content type changes
    document.querySelectorAll('select[name^="folder_"]').forEach(function(select) {
        select.addEventListener('change', function() {
            updateContentTypePreview(this);
        });
    });
});

function updateContentTypePreview(select) {
    const container = select.closest('.content-type-assignment');
    const preview = container.querySelector('.content-type-preview span');
    if (preview) {
        const selectedText = select.options[select.selectedIndex].text;
        preview.textContent = selectedText;
        
        // Update suggestion badge if different from suggestion
        const suggestionBadge = container.querySelector('.badge.bg-info');
        if (suggestionBadge) {
            const originalSuggestion = suggestionBadge.textContent.replace('Suggested: ', '');
            if (selectedText.toLowerCase() !== originalSuggestion.toLowerCase()) {
                suggestionBadge.className = 'badge bg-warning';
                suggestionBadge.innerHTML = '<i class="fas fa-edit me-1"></i>Modified from suggestion';
            } else {
                suggestionBadge.className = 'badge bg-info';
                suggestionBadge.innerHTML = '<i class="fas fa-lightbulb me-1"></i>Suggested: ' + originalSuggestion;
            }
        }
    }
}
</script>
{% endblock %}