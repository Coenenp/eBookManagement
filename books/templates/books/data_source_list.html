{% extends 'books/base.html' %}
{% load custom_filters %}
{% load static %}

{% block title %}Data Sources - Ebook Library Manager{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'book/css/unified-tables.css' %}">
{% endblock %}

{% block extra_js %}
<script src="{% static 'book/js/unified-tables.js' %}"></script>
{% endblock %}

{% block content %}
<div class="unified-table-container">
    <div class="unified-table-header">
        <div>
            <h2 class="unified-table-title">
                <i class="fas fa-database"></i>
                Data Sources
            </h2>
            <p class="unified-table-subtitle">
                Configure trust levels and view usage statistics for metadata sources
            </p>
        </div>
        <div class="unified-table-actions">
            <a href="{% url 'books:data_source_create' %}" class="btn btn-primary">
                <i class="fas fa-plus me-2"></i>Add Data Source
            </a>
            {% if current_sort != 'name' or current_order != 'asc' %}
                <a href="{% url 'books:data_source_list' %}" class="btn btn-outline-secondary btn-sm">
                    <i class="fas fa-times me-1"></i>Clear Sort
                </a>
            {% endif %}
        </div>
    </div>
                        {% if current_sort and current_sort != 'name' or current_order != 'asc' %}
                            <div class="text-end">
                                <small class="text-muted">
                                    <i class="fas fa-sort me-1"></i>Sorted by: 
                                    <span class="text-info">
                                        {% if current_sort == 'name' %}Name{% endif %}
                                        {% if current_sort == 'is_active' %}Active Status{% endif %}
                                        {% if current_sort == 'trust_level' %}Trust Level{% endif %}
                                        {% if current_sort == 'metadata_count' %}Total Metadata{% endif %}
                                        {% if current_sort == 'title_count' %}Title Count{% endif %}
                                        {% if current_sort == 'author_count' %}Author Count{% endif %}
                                        {% if current_sort == 'genre_count' %}Genre Count{% endif %}
                                        {% if current_sort == 'series_count' %}Series Count{% endif %}
                                        {% if current_sort == 'cover_count' %}Cover Count{% endif %}
                                    </span>
                                    {% if current_order == 'desc' %}
                                        <i class="fas fa-sort-down text-info"></i>
                                    {% else %}
                                        <i class="fas fa-sort-up text-info"></i>
                                    {% endif %}
                                </small>
                            </div>
                        {% endif %}
                    </div>
                </div>
                
    {% if data_sources %}
        <div class="table-responsive">
            <table class="table unified-table table-striped table-hover">
                <thead>
                    <tr>
                        <th class="sortable-header {% if current_sort == 'name' %}active sort-{{ current_order }}{% endif %}">
                            <a href="?sort=name&order={% if current_sort == 'name' and current_order == 'asc' %}desc{% else %}asc{% endif %}" class="text-decoration-none">
                                Name
                                <span class="sort-indicator"></span>
                            </a>
                        </th>
                        <th class="sortable-header {% if current_sort == 'is_active' %}active sort-{{ current_order }}{% endif %} text-center">
                            <a href="?sort=is_active&order={% if current_sort == 'is_active' and current_order == 'asc' %}desc{% else %}asc{% endif %}" class="text-decoration-none">
                                Active
                                <span class="sort-indicator"></span>
                            </a>
                        </th>
                        <th class="sortable-header {% if current_sort == 'trust_level' %}active sort-{{ current_order }}{% endif %}">
                            <a href="?sort=trust_level&order={% if current_sort == 'trust_level' and current_order == 'asc' %}desc{% else %}asc{% endif %}" class="text-decoration-none">
                                Trust Level
                                <span class="sort-indicator"></span>
                            </a>
                        </th>
                        <th class="sortable-header {% if current_sort == 'metadata_count' %}active sort-{{ current_order }}{% endif %}">
                            <a href="?sort=metadata_count&order={% if current_sort == 'metadata_count' and current_order == 'asc' %}desc{% else %}asc{% endif %}" class="text-decoration-none">
                                Total Metadata
                                <span class="sort-indicator"></span>
                            </a>
                        </th>
                        <th class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for source in data_sources %}
                    <tr>
                        <td class="item-name" data-label="Name">{{ source.name }}</td>
                        <td class="text-center" data-label="Active">
                            {% if source.is_active %}
                                <span class="status-badge status-active">
                                    <i class="fas fa-check-circle"></i>Active
                                </span>
                            {% else %}
                                <span class="status-badge status-inactive">
                                    <i class="fas fa-times-circle"></i>Inactive
                                </span>
                            {% endif %}
                        </td>
                        <td data-label="Trust Level">
                            <div class="d-flex align-items-center gap-2">
                                <div class="progress trust-level-progress">
                                    <div class="progress-bar {% if source.trust_level >= 0.8 %}bg-success{% elif source.trust_level >= 0.6 %}bg-warning{% else %}bg-danger{% endif %}"
                                         role="progressbar" 
                                         data-width="{% widthratio source.trust_level 1 100 %}"
                                         aria-label="Trust level {{ source.trust_level|floatformat:2 }}"
                                         title="Trust level: {{ source.trust_level|floatformat:2 }}">
                                        <span class="fw-bold">{{ source.trust_level|floatformat:2 }}</span>
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td class="date-display" data-label="Metadata">
                            <span class="stat-value">{{ source.metadata_count }}</span> entries
                        </td>
                        <td class="text-center" data-label="Actions">
                            <div class="action-buttons">
                                <a href="{% url 'books:data_source_update' pk=source.pk %}" 
                                   class="action-btn action-btn-edit"
                                   title="Edit {{ source.name }}">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <a href="{% url 'books:data_source_delete' pk=source.pk %}" 
                                   class="action-btn action-btn-delete"
                                   title="Delete {{ source.name }}">
                                    <i class="fas fa-trash"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Summary Statistics -->
                        <div class="row mt-4 gx-4 gy-3">
                            <!-- ðŸ”¢ Total Sources -->
                            <div class="col-md-3">
                                <div class="card bg-primary text-white">
                                    <div class="card-body text-center">
                                        <h4>{{ data_sources|length }}</h4>
                                        <p class="mb-0">Total Data Sources</p>
                                    </div>
                                </div>
                            </div>

                            <!-- ðŸŸ¢ High Trust Summary -->
                            <div class="col-md-3">
                                <div class="card bg-success text-white">
                                    <div class="card-body text-center">
                                        <h4>{{ high_trust_count }}</h4>
                                        <p class="mb-0">High Trust Sources</p>
                                    </div>
                                </div>
                            </div>

                            <!-- ðŸ§® Average Trust Level -->
                            <div class="col-md-3">
                                <div class="card bg-warning text-dark">
                                    <div class="card-body text-center">
                                        <h4>{{ avg_trust_level|floatformat:2 }}</h4>
                                        <p class="mb-0">Average Trust Level</p>
                                    </div>
                                </div>
                            </div>


                            <!-- ðŸ“Š Total Metadata -->
                            <div class="col-md-3">
                                {% with total=0 %}
                                {% for source in data_sources %}
                                    {% with total=total|add:source.metadata_count %}
                                    {% endwith %}
                                {% endfor %}
                                <div class="card bg-info text-white">
                                    <div class="card-body text-center">
                                        <h4>{{ total }}</h4>
                                        <p class="mb-0">Total Metadata Entries</p>
                                    </div>
                                </div>
                                {% endwith %}
                            </div>

                            <!-- ðŸ¥‡ Top Contributor -->
                            <div class="col-md-12">
                                {% with top_source=data_sources|dictsortreversed:"metadata_count"|first %}
                                <div class="card border border-info">
                                    <div class="card-body text-center">
                                        <h5 class="mb-1">
                                            <i class="fas fa-crown text-warning"></i> 
                                            Top Contributor: <strong>{{ top_source.name }}</strong>
                                        </h5>
                                        <p class="text-muted mb-0">
                                            {{ top_source.metadata_count }} entries at {{ top_source.trust_level|floatformat:2 }} trust
                                        </p>
                                    </div>
                                </div>
                                {% endwith %}
                            </div>
                        </div>
                    {% else %}
                        <div class="alert alert-info text-center">
                            <h4><i class="fas fa-info-circle"></i> No Data Sources</h4>
                            <p>No data sources are currently configured in the system.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Trust Level Edit Modal -->
<div class="modal fade" id="trustLevelModal" tabindex="-1" aria-labelledby="trustLevelModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="trustLevelModalLabel">Edit Trust Level</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="trustLevelForm" method="post">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="form-group mb-3">
                        <label for="trustLevelInput" class="form-label">Trust Level</label>
                        <input type="number" 
                               class="form-control" 
                               id="trustLevelInput" 
                               name="trust_level" 
                               min="0" 
                               max="1" 
                               step="0.05" 
                               required>
                        <div class="form-text">
                            Enter a value between 0.0 and 1.0 in increments of 0.05 (e.g., 0.85, 0.75, 0.65)
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Trust Level</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% load static %}
<link rel="stylesheet" href="{% static 'books/css/data-source-management.css' %}">
<script src="{% static 'book/js/data-source-manager.js' %}"></script>
{% endblock %}