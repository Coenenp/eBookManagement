{% extends "books/base_split_pane.html" %}
{% load static %}

{% block title %}Audiobooks - {{ block.super }}{% endblock %}

{% block list_icon %}fas fa-headphones{% endblock %}
{% block list_title %}Audiobooks{% endblock %}
{% block item_count %}{{ audiobooks_count }}{% endblock %}

{% block search_placeholder %}Search audiobooks by title, author, narrator...{% endblock %}

{% block format_options %}
<option value="mp3">MP3</option>
<option value="m4a">M4A</option>
<option value="m4b">M4B</option>
<option value="flac">FLAC</option>
<option value="ogg">OGG</option>
{% endblock %}

{% block items_list %}
<div id="audiobooks-list-container">
    <!-- Audiobooks will be loaded via AJAX -->
</div>
{% endblock %}

{% block detail_content %}
<div id="audiobook-detail-container">
    <div class="d-flex align-items-center justify-content-center h-100 text-muted">
        <div class="text-center">
            <i class="fas fa-headphones fa-3x mb-3"></i>
            <h5>Select an audiobook to view details</h5>
            <p class="text-muted">Choose from {{ audiobooks_count }} available audiobooks</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
// Audiobooks-specific functionality
let currentAudiobooksData = [];
let filteredAudiobooks = [];

function customLoadItems() {
    showLoadingState(document.getElementById('audiobooks-list-container'), 'Loading audiobooks...');
    
    fetch('{% url "books:audiobooks_ajax_list" %}')
        .then(response => response.json())
        .then(data => {
            currentAudiobooksData = data.audiobooks || [];
            filteredAudiobooks = [...currentAudiobooksData];
            renderAudiobooksList();
            updateItemCount(filteredAudiobooks.length);
        })
        .catch(error => {
            console.error('Error loading audiobooks:', error);
            showEmptyState(
                document.getElementById('audiobooks-list-container'), 
                'fas fa-exclamation-triangle', 
                'Error loading audiobooks. Please try again.'
            );
        });
}

function customFilterItems(searchTerm, sortBy, formatFilter) {
    filteredAudiobooks = currentAudiobooksData.filter(audiobook => {
        // Search filter
        const matchesSearch = !searchTerm || 
            audiobook.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
            audiobook.author.toLowerCase().includes(searchTerm.toLowerCase()) ||
            (audiobook.narrator && audiobook.narrator.toLowerCase().includes(searchTerm.toLowerCase()));
        
        // Format filter - extract format from file_format field
        const bookFormat = audiobook.file_format ? audiobook.file_format.toLowerCase() : '';
        const matchesFormat = !formatFilter || bookFormat === formatFilter.toLowerCase();
        
        return matchesSearch && matchesFormat;
    });
    
    // Sort results
    filteredAudiobooks.sort((a, b) => {
        switch(sortBy) {
            case 'title':
                return a.title.localeCompare(b.title);
            case 'author':
                return a.author.localeCompare(b.author);
            case 'date':
                return new Date(b.last_scanned) - new Date(a.last_scanned);
            case 'size':
                return (b.file_size || 0) - (a.file_size || 0);
            default:
                return a.title.localeCompare(b.title);
        }
    });
    
    renderAudiobooksList();
    updateItemCount(filteredAudiobooks.length);
}

function customRenderView(viewType) {
    renderAudiobooksList(viewType);
}

function customRefreshItems() {
    customLoadItems();
}

function renderAudiobooksList(viewType = null) {
    const container = document.getElementById('audiobooks-list-container');
    const currentView = viewType || (document.getElementById('view-container')?.className.includes('grid') ? 'grid' : 'list');
    
    if (filteredAudiobooks.length === 0) {
        showEmptyState(container, 'fas fa-headphones', 'No audiobooks found');
        return;
    }
    
    const html = filteredAudiobooks.map(audiobook => `
        <div class="list-item" data-item-id="${audiobook.id}" onclick="selectItem(${audiobook.id})">
            <div class="item-title">${escapeHtml(audiobook.title)}</div>
            <div class="item-subtitle">
                by ${escapeHtml(audiobook.author)}
                ${audiobook.narrator ? `<br><small class="text-info">Narrated by ${escapeHtml(audiobook.narrator)}</small>` : ''}
            </div>
            <div class="item-meta">
                <div class="item-badges">
                    <span class="badge bg-success">${audiobook.file_format}</span>
                    ${audiobook.series_name ? `<span class="badge bg-info">${escapeHtml(audiobook.series_name)}</span>` : ''}
                    <span class="badge bg-warning text-dark">
                        <i class="fas fa-headphones me-1"></i>Audio
                    </span>
                    ${audiobook.duration ? `<span class="badge bg-light text-dark">${escapeHtml(audiobook.duration)}</span>` : ''}
                </div>
                <div class="text-muted small">
                    ${formatFileSize(audiobook.file_size)}
                </div>
            </div>
        </div>
    `).join('');
    
    container.innerHTML = html;
    container.classList.add('fade-in');
}

function customLoadDetail(audiobookId) {
    const container = document.getElementById('audiobook-detail-container');
    showLoadingState(container, 'Loading audiobook details...');
    
    fetch(`{% url "books:audiobooks_ajax_detail" 0 %}`.replace('0', audiobookId))
        .then(response => response.json())
        .then(data => {
            renderAudiobookDetail(data.audiobook);
            
            // Handle mobile layout
            if (window.innerWidth <= 768) {
                SplitPane.handleMobileLayout();
                SplitPane.addMobileBackButton();
            }
        })
        .catch(error => {
            console.error('Error loading audiobook detail:', error);
            container.innerHTML = `
                <div class="alert alert-danger m-3">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Error loading audiobook details. Please try again.
                </div>
            `;
        });
}

function renderAudiobookDetail(audiobook) {
    const container = document.getElementById('audiobook-detail-container');
    
    const html = `
        <div class="detail-content">
            <div class="detail-header">
                <h2 class="detail-title">
                    <i class="fas fa-headphones me-2 text-success"></i>
                    ${escapeHtml(audiobook.title)}
                </h2>
                <h5 class="detail-subtitle">by ${escapeHtml(audiobook.author)}</h5>
                ${audiobook.narrator ? `
                    <p class="text-info mb-2">
                        <i class="fas fa-microphone me-1"></i>
                        Narrated by ${escapeHtml(audiobook.narrator)}
                    </p>
                ` : ''}
                ${audiobook.series_name ? `
                    <div class="alert alert-info">
                        <i class="fas fa-layer-group me-2"></i>
                        Part of series: <strong>${escapeHtml(audiobook.series_name)}</strong>
                        ${audiobook.series_position ? ` (Book #${audiobook.series_position})` : ''}
                    </div>
                ` : ''}
                <div class="detail-meta">
                    <div class="detail-meta-item">
                        <div class="detail-meta-label">Format</div>
                        <div class="detail-meta-value">${audiobook.file_format}</div>
                    </div>
                    <div class="detail-meta-item">
                        <div class="detail-meta-label">File Size</div>
                        <div class="detail-meta-value">${formatFileSize(audiobook.file_size)}</div>
                    </div>
                    ${audiobook.duration ? `
                    <div class="detail-meta-item">
                        <div class="detail-meta-label">Duration</div>
                        <div class="detail-meta-value">${escapeHtml(audiobook.duration)}</div>
                    </div>
                    ` : ''}
                    <div class="detail-meta-item">
                        <div class="detail-meta-label">Publisher</div>
                        <div class="detail-meta-value">${escapeHtml(audiobook.publisher || 'Unknown')}</div>
                    </div>
                    <div class="detail-meta-item">
                        <div class="detail-meta-label">Language</div>
                        <div class="detail-meta-value">${escapeHtml(audiobook.language || 'Unknown')}</div>
                    </div>
                    <div class="detail-meta-item">
                        <div class="detail-meta-label">Last Scanned</div>
                        <div class="detail-meta-value">${formatDate(audiobook.last_scanned)}</div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-4 mb-3">
                    ${audiobook.cover_url ? `
                        <img src="${audiobook.cover_url}" alt="Audiobook Cover" class="detail-cover img-fluid">
                    ` : `
                        <div class="detail-cover bg-light d-flex align-items-center justify-content-center detail-cover-placeholder">
                            <i class="fas fa-headphones fa-3x text-muted"></i>
                        </div>
                    `}
                </div>
                <div class="col-md-8">
                    ${audiobook.description ? `
                        <h6 class="fw-bold">Description</h6>
                        <p class="text-muted">${escapeHtml(audiobook.description)}</p>
                    ` : ''}
                    
                    ${audiobook.isbn ? `
                        <div class="mb-2">
                            <strong>ISBN:</strong> ${escapeHtml(audiobook.isbn)}
                        </div>
                    ` : ''}
                    
                    ${audiobook.publication_date ? `
                        <div class="mb-2">
                            <strong>Publication Date:</strong> ${formatDate(audiobook.publication_date)}
                        </div>
                    ` : ''}
                    
                    <div class="audiobook-specific-info">
                        <h6 class="fw-bold">Audiobook Information</h6>
                        <div class="row">
                            <div class="col-6">
                                <small class="text-muted">Audio Format:</small><br>
                                <strong>${audiobook.file_format}</strong>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">File Size:</small><br>
                                <strong>${formatFileSize(audiobook.file_size)}</strong>
                            </div>
                            ${audiobook.duration ? `
                            <div class="col-6 mt-2">
                                <small class="text-muted">Duration:</small><br>
                                <strong>${escapeHtml(audiobook.duration)}</strong>
                            </div>
                            ` : ''}
                            ${audiobook.narrator ? `
                            <div class="col-6 mt-2">
                                <small class="text-muted">Narrator:</small><br>
                                <strong>${escapeHtml(audiobook.narrator)}</strong>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="detail-actions">
                <button class="btn btn-success" onclick="playAudiobook(${audiobook.id})">
                    <i class="fas fa-play me-1"></i>Play Audiobook
                </button>
                <a href="{% url 'books:book_detail' 0 %}".replace('0', '${audiobook.id}') class="btn btn-outline-primary">
                    <i class="fas fa-eye me-1"></i>View Full Details
                </a>
                <a href="{% url 'books:book_metadata' 0 %}".replace('0', '${audiobook.id}') class="btn btn-outline-info">
                    <i class="fas fa-edit me-1"></i>Edit Metadata
                </a>
                <button class="btn btn-outline-success" onclick="rescanAudiobook(${audiobook.id})">
                    <i class="fas fa-sync me-1"></i>Rescan
                </button>
                ${audiobook.file_path ? `
                    <button class="btn btn-outline-secondary" onclick="openFileLocation('${escapeHtml(audiobook.file_path)}')">
                        <i class="fas fa-folder-open me-1"></i>Show in Folder
                    </button>
                ` : ''}
                ${audiobook.series_name ? `
                    <button class="btn btn-outline-info" onclick="viewSeriesAudiobooks('${escapeHtml(audiobook.series_name)}')">
                        <i class="fas fa-layer-group me-1"></i>View Series
                    </button>
                ` : ''}
            </div>
        </div>
    `;
    
    container.innerHTML = html;
    container.classList.add('fade-in');
}

function playAudiobook(audiobookId) {
    // This would open an audio player - for now just show a placeholder
    showToast('Audio player functionality not yet implemented', 'info');
    // In the future, this could:
    // - Open a web-based audio player
    // - Generate a streaming URL for the audiobook
    // - Launch external audio player application
}

function rescanAudiobook(audiobookId) {
    if (!confirm('Are you sure you want to rescan this audiobook? This will fetch fresh metadata from external sources.')) {
        return;
    }
    
    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Rescanning...';
    btn.disabled = true;
    
    fetch(`{% url "books:ajax_rescan_external_metadata" 0 %}`.replace('0', audiobookId), {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCsrfToken(),
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Reload the detail view to show updated data
            customLoadDetail(audiobookId);
            
            // Show success message
            showToast('Audiobook rescanned successfully!', 'success');
        } else {
            showToast('Error rescanning audiobook: ' + (data.error || 'Unknown error'), 'danger');
        }
    })
    .catch(error => {
        console.error('Error rescanning audiobook:', error);
        showToast('Error rescanning audiobook. Please try again.', 'danger');
    })
    .finally(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
    });
}

function openFileLocation(filePath) {
    // This would need to be implemented based on the platform
    // For now, just copy the path to clipboard
    navigator.clipboard.writeText(filePath).then(() => {
        showToast('File path copied to clipboard', 'info');
    });
}

function viewSeriesAudiobooks(seriesName) {
    // Navigate to audiobooks section with series filter
    window.location.href = `{% url 'books:audiobooks_main' %}?series=${encodeURIComponent(seriesName)}`;
}

// Utility functions
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatFileSize(bytes) {
    if (!bytes) return 'Unknown';
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(1024));
    return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
}

function formatDate(dateString) {
    if (!dateString) return 'Unknown';
    const date = new Date(dateString);
    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
}

function getCsrfToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
}

function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" onclick="this.parentElement.remove()" aria-label="Close"></button>
    `;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        if (toast.parentElement) {
            toast.remove();
        }
    }, 5000);
}

// Handle item activation (double-click or Enter)
function onItemActivate(audiobookId) {
    playAudiobook(audiobookId);
}
</script>
{% endblock %}