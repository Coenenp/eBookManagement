{% extends "books/base_split_pane.html" %}
{% load static %}
{% load book_extras %}

{% block title %}Ebooks - {{ block.super }}{% endblock %}

{% block list_icon %}fas fa-book{% endblock %}
{% block list_title %}Ebooks{% endblock %}
{% block item_count %}{{ ebooks_count }}{% endblock %}

{% block search_placeholder %}Search ebooks by title, author...{% endblock %}

{% block format_options %}
<option value="epub">EPUB</option>
<option value="mobi">MOBI</option>
<option value="pdf">PDF</option>
{% endblock %}

{% block items_list %}
<div id="ebooks-list-container">
    {% include 'books/ebook_list_enhanced.html' with ebooks=ebooks %}
</div>
{% endblock %}

{% block detail_content %}
<div id="ebook-detail-container">
    <div class="d-flex align-items-center justify-content-center h-100 text-muted">
        <div class="text-center">
            <i class="fas fa-book fa-4x mb-4 text-primary"></i>
            <h4 class="mb-3">Welcome to Your Ebook Library</h4>
            <p class="mb-2 lead">Select an ebook to view detailed information</p>
            <p class="text-muted">Choose from {{ ebooks_count }} available ebooks</p>
            <div class="mt-4">
                <div class="row text-center">
                    <div class="col-4">
                        <i class="fas fa-search fa-2x text-info mb-2"></i>
                        <p class="small mb-0">Search & Filter</p>
                    </div>
                    <div class="col-4">
                        <i class="fas fa-th-list fa-2x text-success mb-2"></i>
                        <p class="small mb-0">List & Grid Views</p>
                    </div>
                    <div class="col-4">
                        <i class="fas fa-book-open fa-2x text-warning mb-2"></i>
                        <p class="small mb-0">Rich Details</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
// Ebooks-specific functionality
let currentEbooksData = [];
let filteredEbooks = [];

function customLoadItems() {
    showLoadingState(document.getElementById('ebooks-list-container'), 'Loading ebooks...');
    
    console.log('Loading ebooks from:', '{% url "books:ebooks_ajax_list" %}');
    
    fetch('{% url "books:ebooks_ajax_list" %}')
        .then(response => {
            console.log('Ebooks list response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Ebooks data received:', data);
            console.log(`Total ebooks: ${data.ebooks ? data.ebooks.length : 0}`);
            if (data.ebooks && data.ebooks.length > 0) {
                console.log('First ebook ID:', data.ebooks[0].id);
                console.log('First ebook title:', data.ebooks[0].title);
            }
            
            if (data.success) {
                currentEbooksData = data.ebooks || [];
                filteredEbooks = [...currentEbooksData];
                renderEbooksList(filteredEbooks);
                updateItemCount(filteredEbooks.length);
            } else {
                showEmptyState(
                    document.getElementById('ebooks-list-container'), 
                    'fas fa-exclamation-triangle', 
                    'Error loading ebooks: ' + (data.error || 'Unknown error')
                );
            }
        })
        .catch(error => {
            console.error('Error loading ebooks:', error);
            showEmptyState(
                document.getElementById('ebooks-list-container'), 
                'fas fa-exclamation-triangle', 
                'Error loading ebooks. Please try again.'
            );
        });
}

function customFilterItems(searchTerm, sortBy, formatFilter, statusFilter) {
    if (!currentEbooksData) return;
    
    filteredEbooks = currentEbooksData.filter(ebook => {
        // Search filter
        const matchesSearch = !searchTerm || 
            (ebook.title && ebook.title.toLowerCase().includes(searchTerm.toLowerCase())) ||
            (ebook.author && ebook.author.toLowerCase().includes(searchTerm.toLowerCase())) ||
            (ebook.publisher && ebook.publisher.toLowerCase().includes(searchTerm.toLowerCase()));
        
        // Format filter
        const matchesFormat = !formatFilter || ebook.file_format === formatFilter;
        
        // Status filter
        const matchesStatus = !statusFilter || 
            (statusFilter === 'read' && ebook.is_read) ||
            (statusFilter === 'unread' && !ebook.is_read) ||
            (statusFilter === 'reading' && ebook.reading_progress > 0 && !ebook.is_read);
        
        return matchesSearch && matchesFormat && matchesStatus;
    });
    
    // Sort results
    filteredEbooks.sort((a, b) => {
        switch(sortBy) {
            case 'title':
                return (a.title || '').localeCompare(b.title || '');
            case 'author':
                return (a.author || '').localeCompare(b.author || '');
            case 'date':
                return new Date(b.last_scanned || 0) - new Date(a.last_scanned || 0);
            case 'size':
                return (b.file_size || 0) - (a.file_size || 0);
            default:
                return (a.title || '').localeCompare(b.title || '');
        }
    });
    
    renderEbooksList(filteredEbooks);
    updateItemCount(filteredEbooks.length);
}

function customRenderView(viewType) {
    renderEbooksList(filteredEbooks, viewType);
}

function customRefreshItems() {
    customLoadItems();
}

function renderEbooksList(ebooksData = null, viewType = null) {
    const container = document.getElementById('ebooks-list-container');
    const currentView = viewType || (document.getElementById('view-container')?.className.includes('grid') ? 'grid' : 'list');
    const dataToRender = ebooksData || filteredEbooks;
    
    if (dataToRender.length === 0) {
        showEmptyState(container, 'fas fa-book', 'No ebooks found');
        return;
    }
    
    let html = '';
    
    if (currentView === 'grid') {
        // Grid view with cover focus
        html = dataToRender.map(ebook => `
            <div class="list-item grid-item" data-item-id="${ebook.id}" onclick="selectItem(${ebook.id})">
                <div class="grid-cover mb-3">
                    ${ebook.cover_url ? `
                        <img src="${ebook.cover_url}" alt="Book Cover" class="img-fluid rounded shadow">
                    ` : `
                        <div class="placeholder-cover d-flex align-items-center justify-content-center bg-light rounded">
                            <i class="fas fa-book text-muted fa-2x"></i>
                        </div>
                    `}
                    ${ebook.reading_progress > 0 ? `
                        <div class="reading-progress mt-2">
                            <div class="reading-progress-bar" data-width="${ebook.reading_progress}"></div>
                        </div>
                    ` : ''}
                </div>
                <div class="item-title">${escapeHtml(ebook.title)}</div>
                <div class="item-subtitle">${escapeHtml(ebook.author)}</div>
                <div class="item-meta">
                    <div class="item-badges">
                        <span class="badge bg-secondary">${ebook.file_format.toUpperCase()}</span>
                        ${ebook.is_read ? '<span class="badge bg-success">Read</span>' : ''}
                    </div>
                    <div class="text-muted small mt-1">
                        ${formatFileSize(ebook.file_size)}
                    </div>
                </div>
            </div>
        `).join('');
    } else {
        // Table-style list view for high-density browsing
        html = `
            <div class="list-header">
                <div class="list-header-title">Title</div>
                <div class="list-header-author">Author</div>
                <div class="list-header-info">Size â€¢ Format</div>
            </div>
        ` + dataToRender.map(ebook => `
            <div class="list-item" data-item-id="${ebook.id}" onclick="selectItem(${ebook.id})">
                <div class="item-cover-tiny">
                    ${ebook.cover_url ? `
                        <img src="${ebook.cover_url}" alt="Book Cover">
                    ` : `
                        <div class="placeholder-cover">
                            <i class="fas fa-book"></i>
                        </div>
                    `}
                </div>
                <div class="item-title">${escapeHtml(ebook.title)}</div>
                <div class="item-subtitle">${escapeHtml(ebook.author)}</div>
                <div class="item-info">
                    <div class="item-badges">
                        <span class="badge bg-secondary">${ebook.file_format.toUpperCase()}</span>
                        ${ebook.is_read ? '<span class="badge bg-success">âœ“</span>' : ''}
                        ${ebook.reading_progress > 0 && !ebook.is_read ? '<span class="badge bg-warning">ðŸ“–</span>' : ''}
                    </div>
                    <div class="text-muted small">
                        ${formatFileSize(ebook.file_size)}
                    </div>
                </div>
            </div>
        `).join('');
    }
    
    container.innerHTML = html;
    container.classList.add('fade-in');
}

function customLoadDetail(ebookId) {
    const container = document.getElementById('ebook-detail-container');
    showLoadingState(container, 'Loading ebook details...');
    
    const url = `{% url "books:ebooks_ajax_detail" 0 %}`.replace('0', ebookId);
    console.log('Fetching ebook detail from URL:', url);
    console.log('Ebook ID:', ebookId);
    
    fetch(url, {
        credentials: 'same-origin',  // Include cookies for authentication
        headers: {
            'X-Requested-With': 'XMLHttpRequest'  // Indicate this is an AJAX request
        }
    })
        .then(response => {
            console.log('Response status:', response.status);
            console.log('Response headers:', response.headers);
            
            // Check if we got redirected to login
            if (response.url.includes('/login/')) {
                throw new Error('Authentication required. Please log in first.');
            }
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Ebook detail data:', data);
            if (data.success) {
                renderEbookDetail(data.ebook);
            } else {
                throw new Error(data.error || 'Unknown error');
            }
            
            // Handle mobile layout
            if (window.innerWidth <= 768) {
                SplitPane.handleMobileLayout();
                SplitPane.addMobileBackButton();
            }
        })
        .catch(error => {
            console.error('Error loading ebook detail:', error);
            container.innerHTML = `
                <div class="alert alert-danger m-3">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Error loading ebook details: ${error.message}
                    ${error.message.includes('Authentication') ? '<br><a href="/login/" class="btn btn-primary btn-sm mt-2">Login</a>' : ''}
                </div>
            `;
        });
}

function renderEbookDetail(ebook) {
    const container = document.getElementById('ebook-detail-container');
    
    // Enhanced detail view with tabbed interface
    const html = `
        <div class="ebook-detail-wrapper h-100">
            <!-- Header with book title and cover -->
            <div class="detail-header p-3 border-bottom bg-white sticky-top">
                <div class="row align-items-center">
                    <div class="col-auto">
                        <div class="detail-cover-small">
                            ${ebook.cover_url ? `
                                <img src="${ebook.cover_url}" alt="Book Cover" class="img-fluid rounded shadow-sm">
                            ` : `
                                <div class="placeholder-cover d-flex align-items-center justify-content-center bg-light rounded">
                                    <i class="fas fa-book text-muted"></i>
                                </div>
                            `}
                        </div>
                    </div>
                    <div class="col">
                        <h4 class="mb-1 text-truncate">${escapeHtml(ebook.title)}</h4>
                        <p class="text-muted mb-1">${escapeHtml(ebook.author || 'Unknown Author')}</p>
                        <div class="d-flex align-items-center gap-2">
                            ${ebook.series_name ? `<span class="badge bg-secondary">${escapeHtml(ebook.series_name)}</span>` : ''}
                            ${ebook.file_format ? `<span class="badge bg-info">${ebook.file_format.toUpperCase()}</span>` : ''}
                            ${ebook.language ? `<span class="badge bg-success">${ebook.language.toUpperCase()}</span>` : ''}
                        </div>
                    </div>
                    <div class="col-auto">
                        <div class="btn-group" role="group">
                            <a href="/book/${ebook.id}/" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-edit me-1"></i>Edit
                            </a>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="downloadEbook(${ebook.id})">
                                <i class="fas fa-download me-1"></i>Download
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabbed Content Area -->
            <div class="detail-tabs-container flex-grow-1 d-flex flex-column">
                <!-- Tab Navigation -->
                <ul class="nav nav-tabs nav-justified border-bottom" id="ebookDetailTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="details-tab" data-bs-toggle="tab" 
                                data-bs-target="#details-panel" type="button" role="tab">
                            <i class="fas fa-info-circle me-2"></i>Details
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="media-files-tab" data-bs-toggle="tab" 
                                data-bs-target="#media-files-panel" type="button" role="tab">
                            <i class="fas fa-file-alt me-2"></i>Media Files
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="covers-tab" data-bs-toggle="tab" 
                                data-bs-target="#covers-panel" type="button" role="tab">
                            <i class="fas fa-images me-2"></i>Covers
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="contributors-tab" data-bs-toggle="tab" 
                                data-bs-target="#contributors-panel" type="button" role="tab">
                            <i class="fas fa-users me-2"></i>Contributors
                        </button>
                    </li>
                </ul>

                <!-- Tab Content -->
                <div class="tab-content flex-grow-1 overflow-auto" id="ebookDetailTabContent">
                    <!-- Details Panel -->
                    <div class="tab-pane fade show active h-100" id="details-panel" role="tabpanel">
                        <div class="p-3">
                            <div class="row">
                                <!-- Left column - Cover and basic info -->
                                <div class="col-md-4 mb-3">
                                    <div class="card">
                                        <div class="card-body text-center">
                                            ${ebook.cover_url ? `
                                                <img src="${ebook.cover_url}" alt="Book Cover" class="detail-cover img-fluid mb-3 rounded shadow">
                                            ` : `
                                                <div class="detail-cover bg-light d-flex align-items-center justify-content-center detail-cover-placeholder mb-3 rounded">
                                                    <i class="fas fa-book fa-3x text-muted"></i>
                                                </div>
                                            `}
                                            
                                            <!-- Action buttons -->
                                            <div class="d-grid gap-2">
                                                <a href="/book/${ebook.id}/" class="btn btn-primary">
                                                    <i class="fas fa-book-open me-2"></i>View Full Details
                                                </a>
                                                <button class="btn btn-outline-secondary" onclick="rescanEbook(${ebook.id})">
                                                    <i class="fas fa-sync me-2"></i>Rescan
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Right column - Detailed metadata -->
                                <div class="col-md-8">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Book Information</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="row mb-3">
                                                <div class="col-sm-3"><strong>Title:</strong></div>
                                                <div class="col-sm-9">${escapeHtml(ebook.title || 'N/A')}</div>
                                            </div>
                                            <div class="row mb-3">
                                                <div class="col-sm-3"><strong>Author:</strong></div>
                                                <div class="col-sm-9">${escapeHtml(ebook.author || 'Unknown')}</div>
                                            </div>
                                            <div class="row mb-3">
                                                <div class="col-sm-3"><strong>Publisher:</strong></div>
                                                <div class="col-sm-9">${escapeHtml(ebook.publisher || 'N/A')}</div>
                                            </div>
                                            <div class="row mb-3">
                                                <div class="col-sm-3"><strong>Publication Date:</strong></div>
                                                <div class="col-sm-9">${ebook.publication_date ? formatDate(ebook.publication_date) : 'N/A'}</div>
                                            </div>
                                            <div class="row mb-3">
                                                <div class="col-sm-3"><strong>ISBN:</strong></div>
                                                <div class="col-sm-9">${escapeHtml(ebook.isbn || 'N/A')}</div>
                                            </div>
                                            <div class="row mb-3">
                                                <div class="col-sm-3"><strong>Language:</strong></div>
                                                <div class="col-sm-9">${escapeHtml(ebook.language || 'N/A')}</div>
                                            </div>
                                            <div class="row mb-3">
                                                <div class="col-sm-3"><strong>Genres:</strong></div>
                                                <div class="col-sm-9">
                                                    ${ebook.genres && ebook.genres.length > 0 ? 
                                                        ebook.genres.map(genre => `<span class="badge bg-secondary me-1">${escapeHtml(genre)}</span>`).join('') : 
                                                        'N/A'
                                                    }
                                                </div>
                                            </div>
                                            <div class="row mb-3">
                                                <div class="col-sm-3"><strong>Series:</strong></div>
                                                <div class="col-sm-9">
                                                    ${ebook.series_name ? 
                                                        `${escapeHtml(ebook.series_name)}${ebook.series_position ? ` #${ebook.series_position}` : ''}` : 
                                                        'N/A'
                                                    }
                                                </div>
                                            </div>
                                            <div class="row mb-3">
                                                <div class="col-sm-3"><strong>Page Count:</strong></div>
                                                <div class="col-sm-9">${ebook.page_count || 'N/A'}</div>
                                            </div>
                                            <div class="row mb-3">
                                                <div class="col-sm-3"><strong>Description:</strong></div>
                                                <div class="col-sm-9">
                                                    <div class="description-text">
                                                        ${escapeHtml(ebook.description || 'No description available.')}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- File System Information -->
                                    <div class="card mt-3">
                                        <div class="card-header">
                                            <h6 class="mb-0"><i class="fas fa-hdd me-2"></i>File System</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="row mb-2">
                                                <div class="col-sm-3"><strong>Path:</strong></div>
                                                <div class="col-sm-9"><code class="text-break">${escapeHtml(ebook.file_path || 'N/A')}</code></div>
                                            </div>
                                            <div class="row mb-2">
                                                <div class="col-sm-3"><strong>Date Added:</strong></div>
                                                <div class="col-sm-9">${ebook.date_added ? formatDate(ebook.date_added) : 'N/A'}</div>
                                            </div>
                                            <div class="row mb-2">
                                                <div class="col-sm-3"><strong>Last Scanned:</strong></div>
                                                <div class="col-sm-9">${ebook.last_scanned ? formatDate(ebook.last_scanned) : 'N/A'}</div>
                                            </div>
                                            <div class="row mb-2">
                                                <div class="col-sm-3"><strong>Read Status:</strong></div>
                                                <div class="col-sm-9">
                                                    ${ebook.is_read ? 
                                                        '<span class="badge bg-success"><i class="fas fa-check me-1"></i>Read</span>' : 
                                                        '<span class="badge bg-secondary"><i class="fas fa-clock me-1"></i>Unread</span>'
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Media Files Panel -->
                    <div class="tab-pane fade h-100" id="media-files-panel" role="tabpanel">
                        <div class="p-3">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-file-alt me-2"></i>Main Book File</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="row mb-2">
                                                <div class="col-4"><strong>Filename:</strong></div>
                                                <div class="col-8"><code>${escapeHtml(ebook.filename || 'N/A')}</code></div>
                                            </div>
                                            <div class="row mb-2">
                                                <div class="col-4"><strong>Format:</strong></div>
                                                <div class="col-8">${ebook.file_format ? ebook.file_format.toUpperCase() : 'N/A'}</div>
                                            </div>
                                            <div class="row mb-2">
                                                <div class="col-4"><strong>File Size:</strong></div>
                                                <div class="col-8">${formatFileSize(ebook.file_size)}</div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="row mb-2">
                                                <div class="col-4"><strong>Full Path:</strong></div>
                                                <div class="col-8"><code class="text-break">${escapeHtml(ebook.file_path || 'N/A')}</code></div>
                                            </div>
                                            <div class="row mb-2">
                                                <div class="col-4"><strong>Scan Folder:</strong></div>
                                                <div class="col-8">${escapeHtml(ebook.scan_folder || 'N/A')}</div>
                                            </div>
                                            <div class="row mb-2">
                                                <div class="col-4"><strong>Source:</strong></div>
                                                <div class="col-8">${escapeHtml(ebook.source || 'Local')}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Companion Files -->
                            <div class="card mt-3">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-files me-2"></i>Companion Files</h6>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Filename</th>
                                                    <th>Size</th>
                                                    <th>Type</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="companion-files-list">
                                                <tr>
                                                    <td colspan="4" class="text-center text-muted">Loading companion files...</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Covers Panel -->
                    <div class="tab-pane fade h-100" id="covers-panel" role="tabpanel">
                        <div class="p-3">
                            <div class="row" id="covers-gallery">
                                ${ebook.cover_url ? `
                                    <div class="col-md-3 mb-3">
                                        <div class="card">
                                            <img src="${ebook.cover_url}" class="card-img-top" alt="Cover">
                                            <div class="card-body text-center">
                                                <small class="text-muted">Primary Cover</small>
                                            </div>
                                        </div>
                                    </div>
                                ` : `
                                    <div class="col-12 text-center text-muted">
                                        <i class="fas fa-image fa-3x mb-3"></i>
                                        <p>No cover images available</p>
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>

                    <!-- Contributors Panel -->
                    <div class="tab-pane fade h-100" id="contributors-panel" role="tabpanel">
                        <div class="p-3">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0"><i class="fas fa-user-edit me-2"></i>Authors</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="contributor-item d-flex align-items-center mb-2">
                                                <div class="contributor-avatar me-3">
                                                    <i class="fas fa-user-circle fa-2x text-muted"></i>
                                                </div>
                                                <div>
                                                    <strong>${escapeHtml(ebook.author || 'Unknown Author')}</strong>
                                                    <div class="text-muted small">Primary Author</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0"><i class="fas fa-users me-2"></i>Other Contributors</h6>
                                        </div>
                                        <div class="card-body">
                                            <p class="text-muted">No additional contributors found</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    container.innerHTML = html;
    
    // Load companion files asynchronously
    loadCompanionFiles(ebook.id);
}

// Function to load companion files
function loadCompanionFiles(ebookId) {
    const tbody = document.getElementById('companion-files-list');
    
    fetch(`/books/ajax/companion-files/${ebookId}/`)
        .then(response => {
            if (response.status === 404) {
                // Endpoint doesn't exist, show placeholder
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Companion files feature not available</td></tr>';
                return;
            }
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (!data) return; // Already handled 404 case above
            
            if (data.files && data.files.length > 0) {
                tbody.innerHTML = data.files.map(file => `
                    <tr>
                        <td><code>${escapeHtml(file.name)}</code></td>
                        <td>${formatFileSize(file.size)}</td>
                        <td>${file.type}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="downloadFile('${file.path}')">
                                <i class="fas fa-download"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            } else {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No companion files found</td></tr>';
            }
        })
        .catch(error => {
            console.error('Error loading companion files:', error);
            tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Companion files not available</td></tr>';
        });
}

// Function to download ebook
function downloadEbook(ebookId) {
    window.location.href = `/books/download/${ebookId}/`;
}

// Function to download companion file
function downloadFile(filePath) {
    window.location.href = `/books/download-file/?path=${encodeURIComponent(filePath)}`;
}

function rescanEbook(ebookId) {
    if (!confirm('Are you sure you want to rescan this ebook? This will fetch fresh metadata from external sources.')) {
        return;
    }
    
    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Rescanning...';
    btn.disabled = true;
    
    fetch(`{% url "books:ajax_rescan_external_metadata" 0 %}`.replace('0', ebookId), {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCsrfToken(),
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin',
        body: JSON.stringify({
            searchTerms: {},
            sources: ['google', 'openlibrary', 'goodreads'],
            options: {
                clearExisting: true,  // Clear existing external metadata to allow fresh data
                forceRefresh: true
            }
        })
    })
    .then(response => {
        console.log('Rescan response status:', response.status);
        console.log('Rescan response content-type:', response.headers.get('content-type'));
        
        // Check if we got redirected to login
        if (response.url.includes('/login/')) {
            throw new Error('Authentication required. Please log in first.');
        }
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        // Check if the response is actually JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            return response.text().then(text => {
                console.log('Non-JSON response:', text);
                throw new Error('Server returned non-JSON response');
            });
        }
        
        return response.json();
    })
    .then(data => {
        console.log('Rescan data:', data);
        if (data.success) {
            // Reload the detail view to show updated data
            customLoadDetail(ebookId);
            
            // Show success message
            showToast('Ebook rescanned successfully!', 'success');
        } else {
            showToast('Error rescanning ebook: ' + (data.error || 'Unknown error'), 'danger');
        }
    })
    .catch(error => {
        console.error('Error rescanning ebook:', error);
        showToast('Error rescanning ebook: ' + error.message, 'danger');
    })
    .finally(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
    });
}

function openFileLocation(filePath) {
    // This would need to be implemented based on the platform
    // For now, just copy the path to clipboard
    navigator.clipboard.writeText(filePath).then(() => {
        showToast('File path copied to clipboard', 'info');
    }).catch(() => {
        showToast('Could not copy path to clipboard', 'warning');
    });
}

// Utility functions
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatFileSize(bytes) {
    if (!bytes) return 'Unknown';
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(1024));
    return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
}

function formatDate(dateString) {
    if (!dateString) return 'Unknown';
    const date = new Date(dateString);
    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
}

function getCsrfToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
}

function showToast(message, type = 'info') {
    // Simple toast implementation
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" onclick="this.parentElement.remove()" aria-label="Close"></button>
    `;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        if (toast.parentElement) {
            toast.remove();
        }
    }, 5000);
}

// Handle item activation (double-click or Enter)
function onItemActivate(ebookId) {
    window.location.href = `{% url 'books:book_detail' 0 %}`.replace('0', ebookId);
}
</script>
{% endblock %}