{% extends 'books/base.html' %}
{% load static %}
{% load book_extras %}
{% load custom_filters %}

{% block title %}Book File Organizer - {{ block.super }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-save me-2"></i>Book File Organizer</h2>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-primary" id="selectAllBtn">
                        <i class="fas fa-check-square me-1"></i>Select All
                    </button>
                    <button type="button" class="btn btn-secondary" id="selectNoneBtn">
                        <i class="fas fa-square me-1"></i>Select None
                    </button>
                    <button type="button" class="btn btn-info" id="selectCompleteSeriesBtn">
                        <i class="fas fa-books me-1"></i>Select Complete Series
                    </button>
                    <button type="button" class="btn btn-warning" id="previewBtn" disabled>
                        <i class="fas fa-eye me-1"></i>Preview Changes
                    </button>
                    <button type="button" class="btn btn-success" id="executeBtn" disabled>
                        <i class="fas fa-save me-1"></i>Execute Rename
                    </button>
                    <a href="{% url 'books:book_renamer_history' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-history me-1"></i>View History
                    </a>
                </div>
            </div>

            <!-- Filter Form -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-filter me-2"></i>Filters
                        <button class="btn btn-sm btn-outline-secondary float-end" type="button" data-bs-toggle="collapse" data-bs-target="#filtersCollapse"
                               aria-label="Toggle filters" title="Toggle filters section">
                            <i class="fas fa-chevron-down"></i>
                        </button>
                    </h5>
                </div>
                <div class="collapse show" id="filtersCollapse">
                    <div class="card-body">
                        <form method="get" class="row g-3">
                            <div class="col-md-3">
                                <label for="search" class="form-label">Search</label>
                                <input type="text" class="form-control" id="search" name="search" 
                                       value="{{ search_query }}" placeholder="Title or Author">
                            </div>
                            <div class="col-md-3">
                                <label for="author" class="form-label">Author</label>
                                <input type="text" class="form-control" id="author" name="author" 
                                       value="{{ author_filter }}" placeholder="Author name">
                            </div>
                            <div class="col-md-2">
                                <label for="language" class="form-label">Language</label>
                                <select class="form-select" id="language" name="language">
                                    <option value="">All Languages</option>
                                    {% for code, name in languages %}
                                        <option value="{{ code }}" {% if language_filter == code %}selected{% endif %}>{{ name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="file_format" class="form-label">Format</label>
                                <select class="form-select" id="file_format" name="file_format">
                                    <option value="">All Formats</option>
                                    {% for value, label in formats %}
                                        <option value="{{ value }}" {% if format_filter == value %}selected{% endif %}>{{ label }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="has_series" class="form-label">Series</label>
                                <select class="form-select" id="has_series" name="has_series">
                                    <option value="">All Books</option>
                                    <option value="true" {% if series_filter == 'true' %}selected{% endif %}>With Series</option>
                                    <option value="false" {% if series_filter == 'false' %}selected{% endif %}>Without Series</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="complete_series" class="form-label">Complete Series</label>
                                <select class="form-select" id="complete_series" name="complete_series">
                                    <option value="">All Books</option>
                                    <option value="true" {% if complete_series_filter == 'true' %}selected{% endif %}>Complete Series Only</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="genre" class="form-label">Genre</label>
                                <input type="text" class="form-control" id="genre" name="genre" 
                                       value="{{ genre_filter }}" placeholder="Genre name">
                            </div>
                            <div class="col-md-3">
                                <label for="confidence_min" class="form-label">Min Confidence</label>
                                <input type="number" class="form-control" id="confidence_min" name="confidence_min" 
                                       value="{{ confidence_filter }}" min="0" max="100" step="1" placeholder="0-100">
                            </div>
                            <div class="col-md-6 d-flex align-items-end">
                                <button type="submit" class="btn btn-primary me-2">
                                    <i class="fas fa-search me-1"></i>Apply Filters
                                </button>
                                <a href="{% url 'books:book_renamer' %}" class="btn btn-secondary">
                                    <i class="fas fa-times me-1"></i>Clear Filters
                                </a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Results Summary -->
            <div class="row mb-3">
                <div class="col-md-4">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-1"></i>
                        Showing {{ books_with_paths|length }} reviewed books ready for organization
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle me-1"></i>
                        <strong>Complete Series:</strong> {{ complete_series|length }} available
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-1"></i>
                        <strong>Structure:</strong> /eBooks Library/[Format]/[Language]/[Category]/[Author]/[Series]/[Title]
                    </div>
                </div>
            </div>

            <!-- Complete Series Info -->
            {% if complete_series %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-layer-group me-2"></i>Complete Series Available
                        <button class="btn btn-sm btn-outline-secondary float-end" type="button" data-bs-toggle="collapse" data-bs-target="#seriesCollapse"
                               aria-label="Toggle series list" title="Toggle complete series list">
                            <i class="fas fa-chevron-down"></i>
                        </button>
                    </h5>
                </div>
                <div class="collapse" id="seriesCollapse">
                    <div class="card-body">
                        <div class="row">
                            {% for series in complete_series %}
                            <div class="col-md-6 mb-3">
                                <div class="card">
                                    <div class="card-body">
                                        <h6 class="card-title">{{ series.series }}</h6>
                                        <p class="card-text">
                                            <strong>Author:</strong> {{ series.author }}<br>
                                            <strong>Books:</strong> {{ series.count }} ({{ series.numbers|join:", " }})
                                        </p>
                                        <button class="btn btn-sm btn-primary select-series-btn" 
                                                data-author="{{ series.author }}" 
                                                data-series="{{ series.series }}">
                                            <i class="fas fa-check me-1"></i>Select This Series
                                        </button>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Books Table -->
            {% if books_with_paths %}
            <form id="renameForm">
                {% csrf_token %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th class="table-col-narrow">
                                    <label for="selectAllCheckbox" class="visually-hidden">Select all books</label>
                                    <input type="checkbox" id="selectAllCheckbox" class="form-check-input" aria-label="Select all books">
                                </th>
                                <th>Book Details</th>
                                <th>Current Path</th>
                                <th>New Organized Path</th>
                                <th class="table-col-status">Status & Warnings</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in books_with_paths %}
                            <tr>
                                <td>
                                    {% if item.can_rename %}
                                    <input type="checkbox" name="selected_books" value="{{ item.book.id }}" 
                                           class="form-check-input book-checkbox"
                                           data-author="{{ item.book.finalmetadata.final_author }}"
                                           data-series="{{ item.book.finalmetadata.final_series }}"
                                           aria-label="Select {{ item.book.finalmetadata.final_title|truncatechars:30 }}"
                                           {% if item.is_complete_series %}data-complete-series="true"{% endif %}>
                                    {% else %}
                                    <i class="fas fa-times text-danger" title="File not found"></i>
                                    {% endif %}
                                </td>
                                <td>
                                    <div>
                                        <strong>{{ item.book.finalmetadata.final_title|truncatechars:50 }}</strong>
                                        {% if item.is_complete_series %}
                                        <span class="badge bg-success ms-2">Complete Series</span>
                                        {% endif %}
                                        <br>
                                        <small class="text-muted">by {{ item.book.finalmetadata.final_author|default:"Unknown" }}</small>
                                        {% if item.book.finalmetadata.final_series %}
                                        <br>
                                        <small class="text-info">
                                            <i class="fas fa-book-open me-1"></i>{{ item.book.finalmetadata.final_series }}
                                            {% if item.book.finalmetadata.final_series_number %} #{{ item.book.finalmetadata.final_series_number }}{% endif %}
                                        </small>
                                        {% endif %}
                                        <br>
                                        <small class="text-secondary">
                                            {{ item.book.file_format|upper }} • {{ item.book.finalmetadata.language|language_name }}
                                        </small>
                                    </div>
                                </td>
                                <td>
                                    <small class="font-monospace text-break">{{ item.current_path|truncatechars:80 }}</small>
                                </td>
                                <td>
                                    <small class="font-monospace text-break text-primary">{{ item.new_path|truncatechars:80 }}</small>
                                </td>
                                <td class="text-center">
                                    {% if item.can_rename %}
                                    <span class="badge bg-success">Ready</span>
                                    {% else %}
                                    <span class="badge bg-danger">Missing</span>
                                    {% endif %}
                                    
                                    {% if item.warnings %}
                                    <div class="mt-1">
                                        {% for warning in item.warnings %}
                                        <div class="alert alert-{{ warning.type }} alert-sm alert-small p-1 mb-1">
                                            {{ warning.message }}
                                        </div>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </form>

            <!-- Pagination -->
            {% if is_paginated %}
            <nav aria-label="Books pagination">
                <ul class="pagination justify-content-center" role="list">{% if page_obj.has_previous %}<li class="page-item" role="listitem"><a class="page-link" href="?{% url_replace page=1 %}">First</a></li><li class="page-item" role="listitem"><a class="page-link" href="?{% url_replace page=page_obj.previous_page_number %}">Previous</a></li>{% endif %}{% for num in page_obj.paginator.page_range %}{% if page_obj.number == num %}<li class="page-item active" role="listitem"><span class="page-link">{{ num }}</span></li>{% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}<li class="page-item" role="listitem"><a class="page-link" href="?{% url_replace page=num %}">{{ num }}</a></li>{% endif %}{% endfor %}{% if page_obj.has_next %}<li class="page-item" role="listitem"><a class="page-link" href="?{% url_replace page=page_obj.next_page_number %}">Next</a></li><li class="page-item" role="listitem"><a class="page-link" href="?{% url_replace page=page_obj.paginator.num_pages %}">Last</a></li>{% endif %}</ul>
            </nav>
            {% endif %}

            {% else %}
            <div class="alert alert-info text-center">
                <i class="fas fa-info-circle me-2"></i>
                No reviewed books found with the current filters.
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="previewModalLabel">
                    <i class="fas fa-eye me-2"></i>Preview File Organization Changes
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="previewContent">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="confirmExecuteBtn">
                    <i class="fas fa-save me-1"></i>Execute Changes
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Progress Modal -->
<div class="modal fade" id="progressModal" tabindex="-1" aria-labelledby="progressModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="progressModalLabel">
                    <i class="fas fa-cog fa-spin me-2"></i>Organizing Files
                </h5>
            </div>
            <div class="modal-body">
                <div class="progress mb-3">
                    <div class="progress-bar progress-bar-width-0" role="progressbar" id="progressBar"></div>
                </div>
                <div id="progressText">Preparing to organize files...</div>
                <div id="progressResults" class="mt-3 d-hidden">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="alert alert-success">
                                <strong>Successful:</strong> <span id="successCount">0</span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="alert alert-warning">
                                <strong>With Warnings:</strong> <span id="warningCount">0</span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="alert alert-danger">
                                <strong>Failed:</strong> <span id="errorCount">0</span>
                            </div>
                        </div>
                    </div>
                    <div id="revertSection" class="mt-3 d-hidden">
                        <div class="alert alert-info">
                            <strong>Need to revert?</strong> 
                            <button type="button" class="btn btn-sm btn-warning ms-2" id="revertBtn">
                                <i class="fas fa-undo me-1"></i>Revert All Changes
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary d-hidden" id="closeProgressBtn" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const selectAllBtn = document.getElementById('selectAllBtn');
    const selectNoneBtn = document.getElementById('selectNoneBtn');
    const selectCompleteSeriesBtn = document.getElementById('selectCompleteSeriesBtn');
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    const previewBtn = document.getElementById('previewBtn');
    const executeBtn = document.getElementById('executeBtn');
    const bookCheckboxes = document.querySelectorAll('.book-checkbox');
    const previewModal = new bootstrap.Modal(document.getElementById('previewModal'));
    const progressModal = new bootstrap.Modal(document.getElementById('progressModal'));

    // Update button states based on selected books
    function updateButtonStates() {
        const selectedCount = document.querySelectorAll('.book-checkbox:checked').length;
        previewBtn.disabled = selectedCount === 0;
        executeBtn.disabled = selectedCount === 0;
    }

    // Select All functionality
    selectAllBtn.addEventListener('click', function() {
        bookCheckboxes.forEach(checkbox => checkbox.checked = true);
        selectAllCheckbox.checked = true;
        updateButtonStates();
    });

    // Select None functionality
    selectNoneBtn.addEventListener('click', function() {
        bookCheckboxes.forEach(checkbox => checkbox.checked = false);
        selectAllCheckbox.checked = false;
        updateButtonStates();
    });

    // Select Complete Series functionality
    selectCompleteSeriesBtn.addEventListener('click', function() {
        bookCheckboxes.forEach(checkbox => {
            if (checkbox.dataset.completeSeries === 'true') {
                checkbox.checked = true;
            }
        });
        updateButtonStates();
    });

    // Series selection buttons
    document.querySelectorAll('.select-series-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const author = this.dataset.author;
            const series = this.dataset.series;
            
            bookCheckboxes.forEach(checkbox => {
                if (checkbox.dataset.author === author && checkbox.dataset.series === series) {
                    checkbox.checked = true;
                }
            });
            updateButtonStates();
        });
    });

    // Header checkbox functionality
    selectAllCheckbox.addEventListener('change', function() {
        bookCheckboxes.forEach(checkbox => checkbox.checked = this.checked);
        updateButtonStates();
    });

    // Individual checkbox changes
    bookCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const checkedCount = document.querySelectorAll('.book-checkbox:checked').length;
            const totalCount = bookCheckboxes.length;
            
            selectAllCheckbox.checked = checkedCount === totalCount;
            selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < totalCount;
            
            updateButtonStates();
        });
    });

    // Preview functionality with warnings check
    previewBtn.addEventListener('click', function() {
        const selectedBooks = Array.from(document.querySelectorAll('.book-checkbox:checked'))
            .map(cb => cb.value);
        
        if (selectedBooks.length === 0) {
            alert('Please select books to preview');
            return;
        }

        // Check for warnings in selected books
        let hasWarnings = false;
        const selectedRows = Array.from(document.querySelectorAll('.book-checkbox:checked'))
            .map(cb => cb.closest('tr'));
        
        selectedRows.forEach(row => {
            if (row.querySelector('.alert-warning, .alert-danger')) {
                hasWarnings = true;
            }
        });

        if (hasWarnings) {
            const proceed = confirm('Some selected books have warnings. Do you want to proceed with the preview?');
            if (!proceed) return;
        }

        // Show preview modal
        previewModal.show();
        
        // Make AJAX request for preview
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        selectedBooks.forEach(id => formData.append('selected_books', id));

        fetch('{% url "books:book_renamer_preview" %}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                document.getElementById('previewContent').innerHTML = 
                    `<div class="alert alert-danger">${data.error}</div>`;
            } else {
                displayPreview(data.preview);
            }
        })
        .catch(error => {
            document.getElementById('previewContent').innerHTML = 
                `<div class="alert alert-danger">Error loading preview: ${error}</div>`;
        });
    });

    // Display preview results
    function displayPreview(previewData) {
        let html = '<div class="table-responsive"><table class="table table-sm">';
        html += '<thead><tr><th>Book</th><th>Current Path</th><th>New Path</th><th>Status</th></tr></thead><tbody>';
        
        previewData.forEach(item => {
            const statusBadge = item.can_rename ? 
                '<span class="badge bg-success">Ready</span>' : 
                '<span class="badge bg-danger">Cannot Rename</span>';
                
            html += `<tr>
                <td><strong>${item.title}</strong><br><small>${item.author}</small></td>
                <td><small class="font-monospace">${item.current_path}</small></td>
                <td><small class="font-monospace text-primary">${item.new_path}</small></td>
                <td>${statusBadge}</td>
            </tr>`;
        });
        
        html += '</tbody></table></div>';
        document.getElementById('previewContent').innerHTML = html;
    }

    // Execute from preview modal
    document.getElementById('confirmExecuteBtn').addEventListener('click', function() {
        previewModal.hide();
        executeRename();
    });

    // Execute functionality
    executeBtn.addEventListener('click', function() {
        if (confirm('Are you sure you want to organize the selected files? This will move files to new locations.')) {
            executeRename();
        }
    });

    function executeRename() {
        const selectedBooks = Array.from(document.querySelectorAll('.book-checkbox:checked'))
            .map(cb => cb.value);
        
        if (selectedBooks.length === 0) {
            alert('Please select books to organize');
            return;
        }

        // Show progress modal
        progressModal.show();
        document.getElementById('progressBar').className = 'progress-bar progress-bar-striped progress-bar-animated progress-bar-width-0';
        document.getElementById('progressText').textContent = 'Starting file organization...';
        document.getElementById('progressResults').className = 'mt-3 d-hidden';
        document.getElementById('closeProgressBtn').className = 'btn btn-primary d-hidden';

        // Make AJAX request for execution
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        selectedBooks.forEach(id => formData.append('selected_books', id));

        fetch('{% url "books:book_renamer_execute" %}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById('progressBar').className = 'progress-bar progress-bar-width-100';
            document.getElementById('progressText').textContent = 'File organization completed!';
            
            document.getElementById('successCount').textContent = data.success.length;
            document.getElementById('warningCount').textContent = data.warnings ? data.warnings.length : 0;
            document.getElementById('errorCount').textContent = data.errors.length;
            document.getElementById('progressResults').className = 'mt-3 d-block';
            document.getElementById('closeProgressBtn').className = 'btn btn-primary d-inline-block';
            
            // Show revert option if there were successful operations
            if (data.success.length > 0 || (data.warnings && data.warnings.length > 0)) {
                document.getElementById('revertSection').className = 'mt-3 d-block';
                
                // Store batch ID for reversal
                window.lastBatchId = data.batch_id;
                
                // Set up revert button
                document.getElementById('revertBtn').addEventListener('click', function() {
                    if (confirm('Are you sure you want to revert all changes? This will move files back to their original locations.')) {
                        revertChanges(data.batch_id);
                    }
                });
            }
            
            // Show detailed results
            if (data.errors.length > 0) {
                let errorDetails = '<div class="mt-3"><h6>Errors:</h6><ul>';
                data.errors.forEach(error => {
                    errorDetails += `<li>${error.title}: ${error.error}</li>`;
                });
                errorDetails += '</ul></div>';
                document.getElementById('progressResults').innerHTML += errorDetails;
            }
            
            if (data.warnings && data.warnings.length > 0) {
                let warningDetails = '<div class="mt-3"><h6>Completed with Warnings:</h6><ul>';
                data.warnings.forEach(warning => {
                    warningDetails += `<li>${warning.title}: ${warning.warnings.join(', ')}</li>`;
                });
                warningDetails += '</ul></div>';
                document.getElementById('progressResults').innerHTML += warningDetails;
            }
            
            // Refresh page after closing modal
            document.getElementById('closeProgressBtn').addEventListener('click', function() {
                window.location.reload();
            });
        })
        .catch(error => {
            document.getElementById('progressBar').className = 'progress-bar progress-bar-width-100 bg-danger';
            document.getElementById('progressText').textContent = 'Error during file organization';
            document.getElementById('closeProgressBtn').className = 'btn btn-primary d-inline-block';
        });
    }

    // Initial button state
    updateButtonStates();
    
    // Revert changes function
    function revertChanges(batchId) {
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        formData.append('batch_id', batchId);
        
        // Hide revert button and show progress
        document.getElementById('revertBtn').disabled = true;
        document.getElementById('revertBtn').innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Reverting...';
        
        fetch('{% url "books:book_renamer_revert" %}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.errors.length === 0) {
                alert(`Successfully reverted ${data.success.length} operations.`);
                window.location.reload();
            } else {
                alert(`Revert completed with ${data.success.length} successes and ${data.errors.length} errors.`);
                console.log('Revert errors:', data.errors);
            }
        })
        .catch(error => {
            alert('Error reverting changes: ' + error);
            document.getElementById('revertBtn').disabled = false;
            document.getElementById('revertBtn').innerHTML = '<i class="fas fa-undo me-1"></i>Revert All Changes';
        });
    }
});
</script>
{% endblock %}
