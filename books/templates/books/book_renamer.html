{% extends 'books/base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}Bulk File Renamer{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'book/css/renamer.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-3">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1>Bulk File Renamer</h1>
                    <p class="text-muted">Apply rename templates to organize your library files</p>
                </div>
                <div class="d-flex gap-2">
                    <a href="{% url 'books:template_management' %}" class="btn btn-outline-primary">
                        <i class="fas fa-cog me-1"></i> Manage Templates
                    </a>
                    <a href="{% url 'books:book_renamer_history' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-history me-1"></i> View History
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Template Selection -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-tag me-2"></i>Select Rename Template</h5>
                </div>
                <div class="card-body">
                    <div class="row align-items-end">
                        <div class="col-md-10 mb-3">
                            <label for="template-selector" class="form-label fw-bold">Active Template</label>
                            <select class="form-select form-select-lg" id="template-selector" name="template_selector">
                                <option value="">-- Select a template to apply --</option>
                                <optgroup label="Your Saved Templates" id="saved-templates-group">
                                    <!-- User templates will be loaded via JS -->
                                </optgroup>
                                <optgroup label="System Templates">
                                    {% for key, pattern in predefined_patterns.items %}
                                    <option value="system-{{ key }}" 
                                            data-folder="{{ pattern.folder }}" 
                                            data-filename="{{ pattern.filename }}">
                                        {{ pattern.name }} - {{ pattern.description }}
                                    </option>
                                    {% endfor %}
                                </optgroup>
                            </select>
                        </div>
                        <div class="col-md-2 mb-3">
                            <a href="{% url 'books:template_management' %}" class="btn btn-outline-secondary w-100">
                                <i class="fas fa-plus me-1"></i> New Template
                            </a>
                        </div>
                    </div>
                    
                    <!-- Pattern Display (Read-only) -->
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label text-muted small">Folder Pattern</label>
                            <div class="font-monospace bg-light p-2 rounded border" id="folder-pattern-display">
                                <em class="text-muted">Select a template...</em>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-muted small">Filename Pattern</label>
                            <div class="font-monospace bg-light p-2 rounded border" id="filename-pattern-display">
                                <em class="text-muted">Select a template...</em>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Book Selection and Actions Section -->
    <div class="row">
        <div class="col-12">
            <div class="card border">
                <div class="card-header bg-body-secondary d-flex flex-wrap justify-content-between align-items-center gap-2">
                    <h5 class="mb-0"><i class="fas fa-books me-2"></i>Books to Rename</h5>
                    <div class="d-flex flex-wrap align-items-center gap-2">
                        <button type="button" class="btn btn-sm btn-outline-primary" id="select-all-btn">
                            <i class="fas fa-check-square me-1"></i> Select All
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" id="select-none-btn">
                            <i class="fas fa-square me-1"></i> Select None
                        </button>
                        <span class="badge bg-info fs-6" id="selection-count">0 selected</span>
                    </div>
                </div>
                <div class="card-body bg-body">
                    <!-- Bulk Selection Tools -->
                    <div class="row mb-3 p-3 bg-light border rounded">
                        <div class="col-12 mb-2">
                            <h6 class="mb-2"><i class="fas fa-layer-group me-1"></i> Quick Selection</h6>
                        </div>
                        <div class="col-md-3">
                            <button type="button" class="btn btn-sm btn-outline-primary w-100" id="select-by-author-btn">
                                <i class="fas fa-user me-1"></i> By Author
                            </button>
                        </div>
                        <div class="col-md-3">
                            <button type="button" class="btn btn-sm btn-outline-primary w-100" id="select-by-series-btn">
                                <i class="fas fa-book-reader me-1"></i> By Series
                            </button>
                        </div>
                        <div class="col-md-3">
                            <button type="button" class="btn btn-sm btn-outline-primary w-100" id="select-by-format-btn">
                                <i class="fas fa-file me-1"></i> By Format
                            </button>
                        </div>
                        <div class="col-md-3">
                            <button type="button" class="btn btn-sm btn-outline-primary w-100" id="select-by-folder-btn">
                                <i class="fas fa-folder me-1"></i> By Scan Folder
                            </button>
                        </div>
                    </div>
                    
                    <!-- Rename Options -->
                    <div class="row mb-3 p-3 bg-primary bg-opacity-10 border border-primary rounded">
                        <div class="col-md-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="include-companions" name="include_companions" {% if include_companion_files %}checked{% endif %}>
                                <label class="form-check-label fw-bold" for="include-companions">
                                    Include companion files
                                    <br><small class="text-muted">(covers, metadata, etc.)</small>
                                </label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="dry-run" name="dry_run" checked>
                                <label class="form-check-label fw-bold" for="dry-run">
                                    Dry run (preview only)
                                    <br><small class="text-muted">Test without making changes</small>
                                </label>
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="d-flex gap-2 justify-content-end">
                                <button type="button" class="btn btn-primary" id="preview-btn" disabled>
                                    <i class="fas fa-eye me-1"></i> Preview Changes
                                </button>
                                <button type="button" class="btn btn-success" id="execute-btn" disabled>
                                    <i class="fas fa-play me-1"></i> Execute Rename
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Filters -->
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <input type="text" class="form-control" id="search-filter" 
                                   placeholder="Search books..." value="{{ request.GET.search }}">
                        </div>
                        <div class="col-md-2">
                            <select class="form-select" id="content-type-filter" name="content_type" aria-label="Filter by content type">
                                <option value="">All Types</option>
                                <option value="ebook" {% if request.GET.content_type == 'ebook' %}selected{% endif %}>eBooks</option>
                                <option value="audiobook" {% if request.GET.content_type == 'audiobook' %}selected{% endif %}>Audiobooks</option>
                                <option value="comic" {% if request.GET.content_type == 'comic' %}selected{% endif %}>Comics</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <select class="form-select" id="format-filter" name="file_format" aria-label="Filter by file format">
                                <option value="">All Formats</option>
                                <optgroup label="eBook Formats">
                                    <option value="epub" {% if request.GET.file_format == 'epub' %}selected{% endif %}>EPUB</option>
                                    <option value="pdf" {% if request.GET.file_format == 'pdf' %}selected{% endif %}>PDF</option>
                                    <option value="mobi" {% if request.GET.file_format == 'mobi' %}selected{% endif %}>MOBI</option>
                                    <option value="azw" {% if request.GET.file_format == 'azw' %}selected{% endif %}>AZW</option>
                                    <option value="azw3" {% if request.GET.file_format == 'azw3' %}selected{% endif %}>AZW3</option>
                                </optgroup>
                                <optgroup label="Comic Formats">
                                    <option value="cbz" {% if request.GET.file_format == 'cbz' %}selected{% endif %}>CBZ</option>
                                    <option value="cbr" {% if request.GET.file_format == 'cbr' %}selected{% endif %}>CBR</option>
                                    <option value="cb7" {% if request.GET.file_format == 'cb7' %}selected{% endif %}>CB7</option>
                                    <option value="cbt" {% if request.GET.file_format == 'cbt' %}selected{% endif %}>CBT</option>
                                </optgroup>
                                <optgroup label="Audio Formats">
                                    <option value="mp3" {% if request.GET.file_format == 'mp3' %}selected{% endif %}>MP3</option>
                                    <option value="m4a" {% if request.GET.file_format == 'm4a' %}selected{% endif %}>M4A</option>
                                    <option value="m4b" {% if request.GET.file_format == 'm4b' %}selected{% endif %}>M4B</option>
                                    <option value="flac" {% if request.GET.file_format == 'flac' %}selected{% endif %}>FLAC</option>
                                </optgroup>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="language-filter" name="language" aria-label="Filter by language">
                                <option value="">All Languages</option>
                                <option value="en" {% if request.GET.language == 'en' %}selected{% endif %}>English</option>
                                <option value="fr" {% if request.GET.language == 'fr' %}selected{% endif %}>French</option>
                                <option value="de" {% if request.GET.language == 'de' %}selected{% endif %}>German</option>
                                <option value="es" {% if request.GET.language == 'es' %}selected{% endif %}>Spanish</option>
                                <option value="it" {% if request.GET.language == 'it' %}selected{% endif %}>Italian</option>
                                <option value="nl" {% if request.GET.language == 'nl' %}selected{% endif %}>Dutch</option>
                                <option value="pt" {% if request.GET.language == 'pt' %}selected{% endif %}>Portuguese</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <div class="d-flex gap-1">
                                <button type="button" class="btn btn-outline-primary flex-grow-1" id="apply-filters-btn">
                                    <i class="fas fa-filter me-1"></i> Apply
                                </button>
                                {% if request.GET.search or request.GET.content_type or request.GET.file_format or request.GET.language %}
                                <a href="{% url 'books:book_renamer' %}" class="btn btn-outline-secondary" title="Clear all filters">
                                    <i class="fas fa-times"></i>
                                </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Books Table -->
                    <div class="table-responsive">
                        <table class="table table-hover table-striped" id="books-table">
                            <thead class="table-secondary sticky-top">
                                <tr>
                                    <th class="text-center">
                                        <input type="checkbox" class="form-check-input" id="select-all-checkbox" aria-label="Select all books">
                                    </th>
                                    <th>Title</th>
                                    <th>Author</th>
                                    <th>Series</th>
                                    <th>Current Path</th>
                                    <th>Preview</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for book_data in books_with_previews %}
                                <tr class="book-row" data-book-id="{{ book_data.book.id }}">
                                    <td>
                                        <input type="checkbox" class="book-checkbox form-check-input" value="{{ book_data.book.id }}" aria-label="Select {{ book_data.book.finalmetadata.final_title|default:'Unknown Title' }}">
                                    </td>
                                    <td>
                                        <strong class="fw-semibold">{{ book_data.book.finalmetadata.final_title|default:"Unknown Title" }}</strong>
                                    </td>
                                    <td>
                                        {{ book_data.book.finalmetadata.final_author|default:"Unknown Author" }}
                                    </td>
                                    <td>
                                        {% if book_data.book.finalmetadata.final_series %}
                                            {{ book_data.book.finalmetadata.final_series }}
                                            {% if book_data.book.finalmetadata.final_series_number %}
                                                <span class="badge bg-secondary ms-1">#{{ book_data.book.finalmetadata.final_series_number }}</span>
                                            {% endif %}
                                        {% else %}
                                            <span class="text-muted fst-italic">Standalone</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small class="text-muted current-path text-truncate d-inline-block">{{ book_data.current_path }}</small>
                                    </td>
                                    <td>
                                        <small class="preview-path text-primary">
                                            {% if book_data.preview %}
                                                <span class="text-truncate d-inline-block">{{ book_data.preview }}</span>
                                            {% else %}
                                                <span class="text-muted fst-italic">Configure patterns to see preview</span>
                                            {% endif %}
                                        </small>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center text-muted">
                                        No books found matching the current filters.
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    {% if is_paginated %}
                    <nav aria-label="Books pagination">
                        <ul class="pagination justify-content-center">
                            {% if page_obj.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?page=1">&laquo; First</a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}">Previous</a>
                                </li>
                            {% endif %}

                            <li class="page-item active">
                                <span class="page-link">
                                    Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                                </span>
                            </li>

                            {% if page_obj.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.next_page_number }}">Next</a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}">Last &raquo;</a>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Results Modal -->
    <div class="modal fade" id="results-modal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="results-title">Renaming Results</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close results modal"></button>
                </div>
                <div class="modal-body" id="results-content">
                    <!-- Results will be populated here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loading-overlay" class="d-none">
    <div class="text-center">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <div class="mt-2">Processing...</div>
    </div>
</div>

</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="{% static 'book/js/renamer.js' %}"></script>
<script>
// Pass default template to JavaScript
window.defaultTemplateKey = '{{ default_template_key|default:"" }}';
</script>
{% endblock %}
