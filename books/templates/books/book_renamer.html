{% extends 'books/base.html' %}
{% load static %}
{% load book_extras %}
{% load custom_filters %}

{% block title %}Book File Organizer - {{ block.super }}{% endblock %}

{% block extra_css %}
{% load static %}
<link rel="stylesheet" href="{% static 'book/css/file-management.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-save me-2"></i>Book File Organizer</h2>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-primary" id="selectAllBtn">
                        <i class="fas fa-check-square me-1"></i>Select All
                    </button>
                    <button type="button" class="btn btn-secondary" id="selectNoneBtn">
                        <i class="fas fa-square me-1"></i>Select None
                    </button>
                    <button type="button" class="btn btn-info" id="selectCompleteSeriesBtn">
                        <i class="fas fa-books me-1"></i>Select Complete Series
                    </button>
                    <button type="button" class="btn btn-warning" id="previewBtn" disabled>
                        <i class="fas fa-eye me-1"></i>Preview Changes
                    </button>
                    <button type="button" class="btn btn-success" id="interactiveRenameBtn" disabled>
                        <i class="fas fa-cog me-1"></i>Interactive Rename
                    </button>
                    <button type="button" class="btn btn-success" id="executeBtn" disabled>
                        <i class="fas fa-save me-1"></i>Execute All
                    </button>
                    <a href="{% url 'books:book_renamer_history' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-history me-1"></i>View History
                    </a>
                </div>
            </div>

            <!-- Filter Form -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-filter me-2"></i>Filters
                        <button class="btn btn-sm btn-outline-secondary float-end" type="button" data-bs-toggle="collapse" data-bs-target="#filtersCollapse"
                               aria-label="Toggle filters" title="Toggle filters section">
                            <i class="fas fa-chevron-down"></i>
                        </button>
                    </h5>
                </div>
                <div class="collapse show" id="filtersCollapse">
                    <div class="card-body">
                        <form method="get" class="row g-3">
                            <div class="col-md-3">
                                <label for="search" class="form-label">Search</label>
                                <input type="text" class="form-control" id="search" name="search" 
                                       value="{{ search_query }}" placeholder="Title or Author">
                            </div>
                            <div class="col-md-3">
                                <label for="author" class="form-label">Author</label>
                                <input type="text" class="form-control" id="author" name="author" 
                                       value="{{ author_filter }}" placeholder="Author name">
                            </div>
                            <div class="col-md-2">
                                <label for="language" class="form-label">Language</label>
                                <select class="form-select" id="language" name="language">
                                    <option value="">All Languages</option>
                                    {% for code, name in languages %}
                                        <option value="{{ code }}" {% if language_filter == code %}selected{% endif %}>{{ name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="file_format" class="form-label">Format</label>
                                <select class="form-select" id="file_format" name="file_format">
                                    <option value="">All Formats</option>
                                    {% for value, label in formats %}
                                        <option value="{{ value }}" {% if format_filter == value %}selected{% endif %}>{{ label }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="has_series" class="form-label">Series</label>
                                <select class="form-select" id="has_series" name="has_series">
                                    <option value="">All Books</option>
                                    <option value="true" {% if series_filter == 'true' %}selected{% endif %}>With Series</option>
                                    <option value="false" {% if series_filter == 'false' %}selected{% endif %}>Without Series</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="complete_series" class="form-label">Complete Series</label>
                                <select class="form-select" id="complete_series" name="complete_series">
                                    <option value="">All Books</option>
                                    <option value="true" {% if complete_series_filter == 'true' %}selected{% endif %}>Complete Series Only</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="issue_type" class="form-label">Comic Type</label>
                                <select class="form-select" id="issue_type" name="issue_type">
                                    <option value="">All Types</option>
                                    <option value="main_series" {% if request.GET.issue_type == 'main_series' %}selected{% endif %}>Main Series</option>
                                    <option value="annual" {% if request.GET.issue_type == 'annual' %}selected{% endif %}>Annuals</option>
                                    <option value="special" {% if request.GET.issue_type == 'special' %}selected{% endif %}>Specials</option>
                                    <option value="collection" {% if request.GET.issue_type == 'collection' %}selected{% endif %}>Collections</option>
                                    <option value="one_shot" {% if request.GET.issue_type == 'one_shot' %}selected{% endif %}>One-Shots</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="genre" class="form-label">Genre</label>
                                <input type="text" class="form-control" id="genre" name="genre" 
                                       value="{{ genre_filter }}" placeholder="Genre name">
                            </div>
                            <div class="col-md-3">
                                <label for="confidence_min" class="form-label">Min Confidence</label>
                                <input type="number" class="form-control" id="confidence_min" name="confidence_min" 
                                       value="{{ confidence_filter }}" min="0" max="100" step="1" placeholder="0-100">
                            </div>
                            <div class="col-md-6 d-flex align-items-end">
                                <button type="submit" class="btn btn-primary me-2">
                                    <i class="fas fa-search me-1"></i>Apply Filters
                                </button>
                                <a href="{% url 'books:book_renamer' %}" class="btn btn-secondary">
                                    <i class="fas fa-times me-1"></i>Clear Filters
                                </a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Results Summary -->
            <div class="row mb-3">
                <div class="col-md-4">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-1"></i>
                        Showing {{ books_with_paths|length }} reviewed books ready for organization
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle me-1"></i>
                        <strong>Complete Series:</strong> {{ complete_series|length }} available
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-1"></i>
                        <strong>Structure:</strong> /eBooks Library/[Format]/[Language]/[Category]/[Author]/[Series]/[Title]
                    </div>
                </div>
            </div>

            <!-- Complete Series Info -->
            {% if complete_series %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-layer-group me-2"></i>Complete Series Available
                        <button class="btn btn-sm btn-outline-secondary float-end" type="button" data-bs-toggle="collapse" data-bs-target="#seriesCollapse"
                               aria-label="Toggle series list" title="Toggle complete series list">
                            <i class="fas fa-chevron-down"></i>
                        </button>
                    </h5>
                </div>
                <div class="collapse" id="seriesCollapse">
                    <div class="card-body">
                        <div class="row">
                            {% for series in complete_series %}
                            <div class="col-md-6 mb-3">
                                <div class="card">
                                    <div class="card-body">
                                        <h6 class="card-title">{{ series.series }}</h6>
                                        <p class="card-text">
                                            <strong>Author:</strong> {{ series.author }}<br>
                                            <strong>Books:</strong> {{ series.count }} ({{ series.numbers|join:", " }})
                                        </p>
                                        <button class="btn btn-sm btn-primary select-series-btn" 
                                                data-author="{{ series.author }}" 
                                                data-series="{{ series.series }}">
                                            <i class="fas fa-check me-1"></i>Select This Series
                                        </button>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Comic Series Analysis -->
            {% if comic_series_analysis and comic_series_analysis.total_series > 0 %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-book-open me-2"></i>Comic Series Analysis
                        <span class="badge bg-primary ms-2">{{ comic_series_analysis.total_series }} Series</span>
                        <button class="btn btn-sm btn-outline-secondary float-end" type="button" data-bs-toggle="collapse" data-bs-target="#comicSeriesCollapse"
                               aria-label="Toggle comic series analysis" title="Toggle comic series analysis">
                            <i class="fas fa-chevron-down"></i>
                        </button>
                    </h5>
                </div>
                <div class="collapse" id="comicSeriesCollapse">
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <div class="alert alert-success">
                                    <i class="fas fa-check-circle me-1"></i>
                                    <strong>Complete:</strong> {{ comic_series_analysis.complete_count }} series
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle me-1"></i>
                                    <strong>Incomplete:</strong> {{ comic_series_analysis.incomplete_count }} series
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-1"></i>
                                    <strong>Organization:</strong> By Issue Type
                                </div>
                            </div>
                        </div>
                        
                        <!-- Complete Comic Series -->
                        {% if comic_series_analysis.complete_series %}
                        <h6><i class="fas fa-check-circle text-success me-2"></i>Complete Comic Series</h6>
                        <div class="row">
                            {% for series in comic_series_analysis.complete_series %}
                            <div class="col-md-6 col-lg-4 mb-2">
                                <div class="card border-success">
                                    <div class="card-body p-2">
                                        <h6 class="card-title mb-1">{{ series.name }}</h6>
                                        {% if series.publisher %}
                                        <p class="card-text text-muted small mb-1">{{ series.publisher }}</p>
                                        {% endif %}
                                        <div class="d-flex justify-content-between align-items-center">
                                            <small class="text-success">
                                                <i class="fas fa-book me-1"></i>{{ series.main_series_count }} Issues
                                                {% if series.annuals_count > 0 %} | {{ series.annuals_count }} Annuals{% endif %}
                                                {% if series.specials_count > 0 %} | {{ series.specials_count }} Specials{% endif %}
                                            </small>
                                            <span class="badge bg-success">{{ series.completeness_percentage }}% Complete</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                        
                        <!-- Incomplete Comic Series -->
                        {% if comic_series_analysis.incomplete_series %}
                        <h6 class="mt-3"><i class="fas fa-exclamation-triangle text-warning me-2"></i>Incomplete Comic Series</h6>
                        <div class="row">
                            {% for series in comic_series_analysis.incomplete_series %}
                            <div class="col-md-6 col-lg-4 mb-2">
                                <div class="card border-warning">
                                    <div class="card-body p-2">
                                        <h6 class="card-title mb-1">{{ series.name }}</h6>
                                        {% if series.publisher %}
                                        <p class="card-text text-muted small mb-1">{{ series.publisher }}</p>
                                        {% endif %}
                                        <div class="d-flex justify-content-between align-items-center">
                                            <small class="text-warning">
                                                <i class="fas fa-book me-1"></i>{{ series.main_series_count }} Issues
                                                {% if series.missing_issues %}
                                                    | Missing: {{ series.missing_issues|length }}
                                                {% endif %}
                                            </small>
                                            <span class="badge bg-warning text-dark">{{ series.completeness_percentage }}% Complete</span>
                                        </div>
                                        {% if series.gap_analysis %}
                                        <small class="text-muted d-block mt-1">
                                            Gaps: {{ series.gap_analysis|join:", " }}
                                        </small>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Books Table -->
            {% if books_with_paths %}
            <form id="renameForm">
                {% csrf_token %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover table-sm">
                        <thead class="table-dark">
                            <tr>
                                <th class="table-col-narrow">
                                    <label for="selectAllCheckbox" class="visually-hidden">Select all books</label>
                                    <input type="checkbox" id="selectAllCheckbox" class="form-check-input" aria-label="Select all books">
                                </th>
                                <th>Title</th>
                                <th>Author</th>
                                <th>Series</th>
                                <th class="table-col-format">Fmt</th>
                                <th class="table-col-lang">Lang</th>
                                <th class="table-col-confidence">Conf</th>
                                <th class="table-col-cover"><i class="fas fa-image"></i></th>
                                <th class="table-col-status">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in books_with_paths %}
                            <tr data-book-id="{{ item.book.id }}" 
                                data-current-path="{{ item.current_path }}"
                                data-new-path="{{ item.new_path }}"
                                data-can-rename="{{ item.can_rename|yesno:'true,false' }}"
                                data-complete-series="{{ item.is_complete_series|yesno:'true,false' }}">
                                <td>
                                    {% if item.can_rename %}
                                    <input type="checkbox" name="selected_books" value="{{ item.book.id }}" 
                                           class="form-check-input book-checkbox"
                                           data-author="{{ item.book.finalmetadata.final_author }}"
                                           data-series="{{ item.book.finalmetadata.final_series }}"
                                           aria-label="Select {{ item.book.finalmetadata.final_title|truncatechars:30 }}"
                                           {% if item.is_complete_series %}data-complete-series="true"{% endif %}>
                                    {% else %}
                                    <i class="fas fa-times text-danger" title="File not found"></i>
                                    {% endif %}
                                </td>
                                <td>
                                    <strong class="text-truncate d-block text-truncate-title" title="{{ item.book.finalmetadata.final_title }}">
                                        {{ item.book.finalmetadata.final_title|truncatechars:50 }}
                                    </strong>
                                    {% if item.is_complete_series %}
                                    <span class="badge bg-success badge-xs">Complete</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="text-truncate d-block text-truncate-author" title="{{ item.book.finalmetadata.final_author }}">
                                        {{ item.book.finalmetadata.final_author|default:"Unknown"|truncatechars:30 }}
                                    </span>
                                </td>
                                <td>
                                    {% if item.book.finalmetadata.final_series %}
                                    <span class="text-truncate d-block text-truncate-series" title="{{ item.book.finalmetadata.final_series }}">
                                        {{ item.book.finalmetadata.final_series|truncatechars:25 }}
                                        {% if item.book.finalmetadata.final_series_number %}
                                        <br><small class="text-muted">#{{ item.book.finalmetadata.final_series_number }}</small>
                                        {% endif %}
                                    </span>
                                    {% else %}
                                    <span class="text-muted small">Standalone</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge bg-secondary badge-xs">{{ item.book.file_format|upper }}</span>
                                </td>
                                <td>
                                    <span class="badge bg-info badge-xs">{{ item.book.finalmetadata.language|language_name|truncatechars:3 }}</span>
                                </td>
                                <td>
                                    {% if item.book.finalmetadata.overall_confidence %}
                                    {% with confidence=item.book.finalmetadata.overall_confidence %}
                                    <span class="badge badge-xs {% if confidence >= 0.8 %}bg-success{% elif confidence >= 0.6 %}bg-warning{% else %}bg-danger{% endif %}">
                                        {{ confidence|floatformat:1 }}
                                    </span>
                                    {% endwith %}
                                    {% else %}
                                    <span class="badge bg-secondary badge-xs">N/A</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if item.book.finalmetadata.has_cover %}
                                    <i class="fas fa-image text-success" title="Has cover"></i>
                                    {% else %}
                                    <i class="far fa-image text-muted" title="No cover"></i>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if item.can_rename %}
                                    <span class="badge bg-success badge-xs">Ready</span>
                                    {% else %}
                                    <span class="badge bg-danger badge-xs">Missing</span>
                                    {% endif %}
                                    
                                    {% if item.warnings %}
                                    <div class="mt-1">
                                        {% for warning in item.warnings %}
                                        <div class="alert alert-{{ warning.type }} alert-sm-custom mb-1">
                                            <small>{{ warning.message|truncatechars:20 }}</small>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </form>

            <!-- Pagination -->
            {% if is_paginated %}
            <nav aria-label="Books pagination">
                <ul class="pagination justify-content-center" role="list">{% if page_obj.has_previous %}<li class="page-item" role="listitem"><a class="page-link" href="?{% url_replace page=1 %}">First</a></li><li class="page-item" role="listitem"><a class="page-link" href="?{% url_replace page=page_obj.previous_page_number %}">Previous</a></li>{% endif %}{% for num in page_obj.paginator.page_range %}{% if page_obj.number == num %}<li class="page-item active" role="listitem"><span class="page-link">{{ num }}</span></li>{% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}<li class="page-item" role="listitem"><a class="page-link" href="?{% url_replace page=num %}">{{ num }}</a></li>{% endif %}{% endfor %}{% if page_obj.has_next %}<li class="page-item" role="listitem"><a class="page-link" href="?{% url_replace page=page_obj.next_page_number %}">Next</a></li><li class="page-item" role="listitem"><a class="page-link" href="?{% url_replace page=page_obj.paginator.num_pages %}">Last</a></li>{% endif %}</ul>
            </nav>
            {% endif %}

            {% else %}
            <div class="alert alert-info text-center">
                <i class="fas fa-info-circle me-2"></i>
                No reviewed books found with the current filters.
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="previewModalLabel">
                    <i class="fas fa-eye me-2"></i>Preview File Organization Changes
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="previewContent">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="confirmExecuteBtn">
                    <i class="fas fa-save me-1"></i>Execute Changes
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Interactive Rename Modal -->
<div class="modal fade" id="interactiveRenameModal" tabindex="-1" aria-labelledby="interactiveRenameModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="interactiveRenameModalLabel">
                    <i class="fas fa-cog me-2"></i>Interactive File Rename
                    <span id="queueProgress" class="badge bg-primary ms-2">1 of 0</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="interactiveContent">
                    <!-- Current book details will be loaded here -->
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="border-bottom pb-2">Current Information</h6>
                            <div class="mb-3">
                                <strong>Title:</strong> <span id="currentTitle"></span>
                            </div>
                            <div class="mb-3">
                                <strong>Author:</strong> <span id="currentAuthor"></span>
                            </div>
                            <div class="mb-3">
                                <strong>Series:</strong> <span id="currentSeries"></span>
                            </div>
                            <div class="mb-3">
                                <strong>Current Path:</strong>
                                <div class="font-monospace text-break bg-light p-2 rounded" id="currentPath"></div>
                            </div>
                            <div class="mb-3">
                                <strong>Current Cover:</strong>
                                <div id="currentCoverContainer">
                                    <img id="currentCover" src="" alt="Current cover" class="img-thumbnail d-none cover-thumbnail">
                                    <span id="noCover" class="text-muted">No cover available</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="border-bottom pb-2">New Information</h6>
                            <div class="mb-3">
                                <strong>New Path:</strong>
                                <div class="font-monospace text-break bg-success bg-opacity-10 p-2 rounded text-success" id="newPath"></div>
                            </div>
                            <div class="mb-3">
                                <strong>New Filename:</strong>
                                <div class="font-monospace text-break bg-info bg-opacity-10 p-2 rounded" id="newFilename"></div>
                            </div>
                            <div class="mb-3">
                                <strong>Cover Status:</strong>
                                <div id="newCoverInfo">
                                    <span id="coverStatus"></span>
                                </div>
                            </div>
                            <div class="mb-3" id="warningsContainer">
                                <strong>Warnings:</strong>
                                <div id="warningsList"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Additional Files Section -->
                    <div id="additionalFilesSection" class="mt-4 d-none">
                        <h6 class="border-bottom pb-2">
                            <i class="fas fa-files me-2"></i>Additional Files
                        </h6>
                        
                        <!-- Automatic Files -->
                        <div id="automaticFilesContainer" class="mb-4 d-none">
                            <div class="alert alert-info">
                                <h6 class="alert-heading mb-2">
                                    <i class="fas fa-magic me-2"></i>Files that will be automatically renamed
                                </h6>
                                <p class="mb-2">These files will be renamed with the book automatically (cover images, metadata files, etc.):</p>
                                <div id="automaticFilesList"></div>
                            </div>
                        </div>
                        
                        <!-- Optional Files -->
                        <div id="optionalFilesContainer" class="mb-4 d-none">
                            <div class="alert alert-warning">
                                <h6 class="alert-heading mb-2">
                                    <i class="fas fa-question-circle me-2"></i>Additional files found - Choose action
                                </h6>
                                <p class="mb-3">These files were found in the same directory. Choose what to do with each:</p>
                                <div id="optionalFilesList"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <div class="d-flex justify-content-between w-100">
                    <div>
                        <button type="button" class="btn btn-danger" id="abortQueueBtn">
                            <i class="fas fa-stop me-1"></i>Abort Queue
                        </button>
                    </div>
                    <div>
                        <button type="button" class="btn btn-secondary" id="rejectBtn">
                            <i class="fas fa-times me-1"></i>Reject
                        </button>
                        <button type="button" class="btn btn-warning" id="acceptAllBtn">
                            <i class="fas fa-check-double me-1"></i>Accept All Remaining
                        </button>
                        <button type="button" class="btn btn-success" id="acceptBtn">
                            <i class="fas fa-check me-1"></i>Accept
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Progress Modal -->
<div class="modal fade" id="progressModal" tabindex="-1" aria-labelledby="progressModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="progressModalLabel">
                    <i class="fas fa-cog fa-spin me-2"></i>Organizing Files
                </h5>
            </div>
            <div class="modal-body">
                <div class="progress mb-3">
                    <div class="progress-bar progress-bar-width-0" role="progressbar" id="progressBar"></div>
                </div>
                <div id="progressText">Preparing to organize files...</div>
                <div id="progressResults" class="mt-3 d-hidden">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="alert alert-success">
                                <strong>Successful:</strong> <span id="successCount">0</span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="alert alert-warning">
                                <strong>With Warnings:</strong> <span id="warningCount">0</span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="alert alert-danger">
                                <strong>Failed:</strong> <span id="errorCount">0</span>
                            </div>
                        </div>
                    </div>
                    <div id="revertSection" class="mt-3 d-hidden">
                        <div class="alert alert-info">
                            <strong>Need to revert?</strong> 
                            <button type="button" class="btn btn-sm btn-warning ms-2" id="revertBtn">
                                <i class="fas fa-undo me-1"></i>Revert All Changes
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary d-hidden" id="closeProgressBtn" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'book/js/book-renamer.js' %}"></script>
<script>
// Initialize book renamer when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    const selectAllBtn = document.getElementById('selectAllBtn');
    const selectNoneBtn = document.getElementById('selectNoneBtn');
    const selectCompleteSeriesBtn = document.getElementById('selectCompleteSeriesBtn');
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    const previewBtn = document.getElementById('previewBtn');
    const executeBtn = document.getElementById('executeBtn');
    const interactiveRenameBtn = document.getElementById('interactiveRenameBtn');
    const bookCheckboxes = document.querySelectorAll('.book-checkbox');
    const previewModal = new bootstrap.Modal(document.getElementById('previewModal'));
    const progressModal = new bootstrap.Modal(document.getElementById('progressModal'));
    const interactiveModal = new bootstrap.Modal(document.getElementById('interactiveRenameModal'));
    
    // Interactive rename queue management
    let renameQueue = [];
    let currentBookIndex = 0;
    let processedBooks = {
        success: [],
        errors: [],
        skipped: []
    };

    // Update button states based on selected books
    function updateButtonStates() {
        const selectedCount = document.querySelectorAll('.book-checkbox:checked').length;
        previewBtn.disabled = selectedCount === 0;
        executeBtn.disabled = selectedCount === 0;
        interactiveRenameBtn.disabled = selectedCount === 0;
    }

    // Select All functionality
    selectAllBtn.addEventListener('click', function() {
        bookCheckboxes.forEach(checkbox => checkbox.checked = true);
        selectAllCheckbox.checked = true;
        updateButtonStates();
    });

    // Select None functionality
    selectNoneBtn.addEventListener('click', function() {
        bookCheckboxes.forEach(checkbox => checkbox.checked = false);
        selectAllCheckbox.checked = false;
        updateButtonStates();
    });

    // Select Complete Series functionality
    selectCompleteSeriesBtn.addEventListener('click', function() {
        bookCheckboxes.forEach(checkbox => {
            if (checkbox.dataset.completeSeries === 'true') {
                checkbox.checked = true;
            }
        });
        updateButtonStates();
    });

    // Series selection buttons
    document.querySelectorAll('.select-series-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const author = this.dataset.author;
            const series = this.dataset.series;
            
            bookCheckboxes.forEach(checkbox => {
                if (checkbox.dataset.author === author && checkbox.dataset.series === series) {
                    checkbox.checked = true;
                }
            });
            updateButtonStates();
        });
    });

    // Header checkbox functionality
    selectAllCheckbox.addEventListener('change', function() {
        bookCheckboxes.forEach(checkbox => checkbox.checked = this.checked);
        updateButtonStates();
    });

    // Individual checkbox changes
    bookCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const checkedCount = document.querySelectorAll('.book-checkbox:checked').length;
            const totalCount = bookCheckboxes.length;
            
            selectAllCheckbox.checked = checkedCount === totalCount;
            selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < totalCount;
            
            updateButtonStates();
        });
    });

    // Interactive rename functionality
    interactiveRenameBtn.addEventListener('click', function() {
        const selectedBooks = Array.from(document.querySelectorAll('.book-checkbox:checked'));
        
        if (selectedBooks.length === 0) {
            alert('Please select books for interactive rename');
            return;
        }

        // Build rename queue from selected books
        renameQueue = selectedBooks.map(checkbox => {
            const row = checkbox.closest('tr');
            return {
                id: checkbox.value,
                title: row.querySelector('td:nth-child(2) strong').textContent.trim(),
                author: row.querySelector('td:nth-child(3) span').textContent.trim(),
                series: row.querySelector('td:nth-child(4) span').textContent.trim(),
                currentPath: row.dataset.currentPath,
                newPath: row.dataset.newPath,
                canRename: row.dataset.canRename === 'true'
            };
        });

        currentBookIndex = 0;
        processedBooks = {
            success: [],
            errors: [],
            skipped: []
        };
        showCurrentBook();
        interactiveModal.show();
    });

    function showCurrentBook() {
        if (currentBookIndex >= renameQueue.length) {
            // Queue completed - show summary and exit gracefully
            showCompletionSummary();
            return;
        }

        const book = renameQueue[currentBookIndex];
        
        // Update progress
        document.getElementById('queueProgress').textContent = `${currentBookIndex + 1} of ${renameQueue.length}`;
        
        // Update current info
        document.getElementById('currentTitle').textContent = book.title;
        document.getElementById('currentAuthor').textContent = book.author;
        document.getElementById('currentSeries').textContent = book.series === 'Standalone' ? 'None' : book.series;
        document.getElementById('currentPath').textContent = book.currentPath;
        
        // Update new info
        document.getElementById('newPath').textContent = book.newPath;
        const newFilename = book.newPath.split('/').pop();
        document.getElementById('newFilename').textContent = newFilename;
        
        // Cover info - simplified for now
        document.getElementById('coverStatus').innerHTML = book.canRename ? 
            '<span class="badge bg-success">Will be preserved</span>' : 
            '<span class="badge bg-warning">File missing</span>';
            
        // Hide cover elements for now - can be enhanced later
        document.getElementById('currentCover').classList.add('d-none');
        document.getElementById('noCover').classList.remove('d-none');
        
        // Load detailed file information
        loadDetailedFileInfo(book.id);
        
        // Load warnings via AJAX call
        loadBookWarnings(book.id);
    }

    function loadDetailedFileInfo(bookId) {
        // Hide additional files section initially
        document.getElementById('additionalFilesSection').classList.add('d-none');
        document.getElementById('automaticFilesContainer').classList.add('d-none');
        document.getElementById('optionalFilesContainer').classList.add('d-none');
        
        // Make AJAX request for detailed file info
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        formData.append('book_id', bookId);

        fetch('{% url "books:book_renamer_file_details" %}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayAdditionalFiles(data.automatic_files, data.optional_files);
            } else {
                console.error('Error loading file details:', data.error);
            }
        })
        .catch(error => {
            console.error('Error fetching file details:', error);
        });
    }

    function displayAdditionalFiles(automaticFiles, optionalFiles) {
        const hasAutomaticFiles = automaticFiles && automaticFiles.length > 0;
        const hasOptionalFiles = optionalFiles && optionalFiles.length > 0;
        
        if (!hasAutomaticFiles && !hasOptionalFiles) {
            document.getElementById('additionalFilesSection').classList.add('d-none');
            return;
        }
        
        document.getElementById('additionalFilesSection').classList.remove('d-none');
        
        // Display automatic files
        if (hasAutomaticFiles) {
            document.getElementById('automaticFilesContainer').classList.remove('d-none');
            const automaticList = document.getElementById('automaticFilesList');
            automaticList.innerHTML = automaticFiles.map(file => `
                <div class="file-item d-flex justify-content-between align-items-center border rounded p-2 mb-2 bg-light">
                    <div class="flex-grow-1">
                        <div class="fw-bold">${file.original_name} → ${file.new_name}</div>
                        <small class="text-muted">${file.description} (${file.size_formatted})</small>
                    </div>
                    <span class="auto-rename-badge">Auto-rename</span>
                </div>
            `).join('');
        }
        
        // Display optional files
        if (hasOptionalFiles) {
            document.getElementById('optionalFilesContainer').classList.remove('d-none');
            const optionalList = document.getElementById('optionalFilesList');
            optionalList.innerHTML = optionalFiles.map((file, index) => `
                <div class="file-item border rounded p-3 mb-3 bg-white">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="fw-bold mb-1">
                                <i class="fas fa-file me-1"></i>${file.original_name}
                            </div>
                            <div class="text-muted mb-2">${file.description} (${file.size_formatted})</div>
                            <div class="font-monospace small">
                                <div class="mb-1">
                                    <strong>Current:</strong> 
                                    <span class="text-primary">${file.original}</span>
                                </div>
                                <div>
                                    <strong>New:</strong> 
                                    <span class="text-success">${file.new}</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="file-action-group btn-group-vertical w-100" role="group">
                                <input type="radio" class="btn-check" name="fileAction_${index}" id="rename_${index}" value="rename" checked>
                                <label class="btn btn-outline-primary btn-sm" for="rename_${index}">
                                    <i class="fas fa-edit me-1"></i>Rename with book
                                </label>
                                
                                <input type="radio" class="btn-check" name="fileAction_${index}" id="delete_${index}" value="delete">
                                <label class="btn btn-outline-danger btn-sm" for="delete_${index}">
                                    <i class="fas fa-trash me-1"></i>Delete file
                                </label>
                                
                                <input type="radio" class="btn-check" name="fileAction_${index}" id="skip_${index}" value="skip">
                                <label class="btn btn-outline-secondary btn-sm" for="skip_${index}">
                                    <i class="fas fa-times me-1"></i>Leave unchanged
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
    }

    function showCompletionSummary() {
        // Update modal content to show completion summary
        const totalProcessed = processedBooks.success.length + processedBooks.errors.length + processedBooks.skipped.length;
        
        document.getElementById('interactiveContent').innerHTML = `
            <div class="text-center">
                <div class="mb-4">
                    <i class="fas fa-check-circle text-success success-icon-large"></i>
                </div>
                <h4>Interactive Rename Completed!</h4>
                <div class="row mt-4">
                    <div class="col-md-4">
                        <div class="card border-success">
                            <div class="card-body text-center">
                                <h5 class="card-title text-success">${processedBooks.success.length}</h5>
                                <p class="card-text">Successfully Renamed</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card border-warning">
                            <div class="card-body text-center">
                                <h5 class="card-title text-warning">${processedBooks.skipped.length}</h5>
                                <p class="card-text">Skipped</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card border-danger">
                            <div class="card-body text-center">
                                <h5 class="card-title text-danger">${processedBooks.errors.length}</h5>
                                <p class="card-text">Errors</p>
                            </div>
                        </div>
                    </div>
                </div>
                ${processedBooks.errors.length > 0 ? `
                    <div class="mt-3">
                        <h6>Error Details:</h6>
                        <div class="text-start">
                            ${processedBooks.errors.map(error => 
                                `<div class="alert alert-danger alert-sm">${error.title}: ${error.error}</div>`
                            ).join('')}
                        </div>
                    </div>
                ` : ''}
            </div>
        `;
        
        // Update modal title
        document.getElementById('interactiveRenameModalLabel').innerHTML = `
            <i class="fas fa-check-circle me-2 text-success"></i>Rename Complete
        `;
        
        // Update footer buttons
        document.querySelector('#interactiveRenameModal .modal-footer').innerHTML = `
            <div class="d-flex justify-content-center w-100">
                <button type="button" class="btn btn-primary" id="returnToTableBtn">
                    <i class="fas fa-table me-1"></i>Return to Table
                </button>
                <button type="button" class="btn btn-success ms-2" id="refreshPageBtn">
                    <i class="fas fa-sync me-1"></i>Refresh Page
                </button>
            </div>
        `;
        
        // Add event listeners for new buttons
        document.getElementById('returnToTableBtn').addEventListener('click', function() {
            interactiveModal.hide();
            // Uncheck processed books and update UI
            updateTableAfterCompletion();
        });
        
        document.getElementById('refreshPageBtn').addEventListener('click', function() {
            window.location.reload();
        });
    }

    function updateTableAfterCompletion() {
        // Uncheck all processed books
        const allProcessedIds = [
            ...processedBooks.success.map(book => book.id),
            ...processedBooks.errors.map(book => book.id),
            ...processedBooks.skipped.map(book => book.id)
        ];
        
        allProcessedIds.forEach(bookId => {
            const checkbox = document.querySelector(`input[value="${bookId}"]`);
            if (checkbox) {
                checkbox.checked = false;
            }
        });
        
        // Update button states
        updateButtonStates();
        
        // Show a brief success message
        if (processedBooks.success.length > 0) {
            const successAlert = document.createElement('div');
            successAlert.className = 'alert alert-success alert-dismissible fade show';
            successAlert.innerHTML = `
                <strong>Success!</strong> ${processedBooks.success.length} book(s) renamed successfully.
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            document.querySelector('.container-fluid').prepend(successAlert);
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                if (successAlert.parentNode) {
                    successAlert.remove();
                }
            }, 5000);
        }
    }

    function loadBookWarnings(bookId) {
        // Simple implementation - in production, this would be an AJAX call
        const warningsContainer = document.getElementById('warningsContainer');
        const warningsList = document.getElementById('warningsList');
        
        // For now, show basic status
        const book = renameQueue[currentBookIndex];
        if (!book.canRename) {
            warningsList.innerHTML = '<div class="alert alert-danger alert-sm">Original file not found</div>';
            warningsContainer.classList.remove('d-none');
        } else {
            warningsContainer.classList.add('d-none');
        }
    }

    // Interactive modal controls
    document.getElementById('acceptBtn').addEventListener('click', function() {
        const book = renameQueue[currentBookIndex];
        performSingleRename(book.id, true);
    });

    document.getElementById('rejectBtn').addEventListener('click', function() {
        // Skip this book
        const book = renameQueue[currentBookIndex];
        processedBooks.skipped.push({
            id: book.id,
            title: book.title
        });
        currentBookIndex++;
        showCurrentBook();
    });

    document.getElementById('acceptAllBtn').addEventListener('click', function() {
        if (confirm('Accept all remaining books in the queue?')) {
            interactiveModal.hide();
            const remainingBooks = renameQueue.slice(currentBookIndex).map(book => book.id);
            performBatchRename(remainingBooks);
        }
    });

    document.getElementById('abortQueueBtn').addEventListener('click', function() {
        if (confirm('Abort the rename queue? No changes will be made.')) {
            // Mark all remaining as skipped
            const remainingBooks = renameQueue.slice(currentBookIndex);
            remainingBooks.forEach(book => {
                processedBooks.skipped.push({
                    id: book.id,
                    title: book.title,
                    reason: 'Aborted by user'
                });
            });
            
            // Set current index to end and show completion
            currentBookIndex = renameQueue.length;
            showCompletionSummary();
        }
    });

    function performSingleRename(bookId, accept) {
        if (!accept) {
            // Skip this book
            const book = renameQueue[currentBookIndex];
            processedBooks.skipped.push({
                id: book.id,
                title: book.title,
                reason: 'Rejected by user'
            });
            currentBookIndex++;
            showCurrentBook();
            return;
        }

        const currentBook = renameQueue[currentBookIndex];

        // Collect file actions for optional files
        const fileActions = [];
        const optionalFileInputs = document.querySelectorAll('input[name^="fileAction_"]:checked');
        optionalFileInputs.forEach((input, index) => {
            fileActions.push({
                index: index,
                action: input.value
            });
        });

        // Perform single book rename via AJAX
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        formData.append('selected_books', bookId);
        formData.append('file_actions', JSON.stringify(fileActions));

        fetch('{% url "books:book_renamer_execute" %}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.success.length > 0) {
                // Success - track it and move to next book
                const result = data.success[0];
                processedBooks.success.push({
                    id: bookId,
                    title: currentBook.title,
                    newPath: result.new_path,
                    additionalFiles: result.additional_files || [],
                    fileActions: fileActions
                });
                currentBookIndex++;
                showCurrentBook();
            } else if (data.warnings && data.warnings.length > 0) {
                // Warning - still successful but with issues
                const result = data.warnings[0];
                processedBooks.success.push({
                    id: bookId,
                    title: currentBook.title,
                    newPath: result.new_path,
                    warnings: result.warnings,
                    additionalFiles: result.additional_files || [],
                    fileActions: fileActions
                });
                currentBookIndex++;
                showCurrentBook();
            } else if (data.errors && data.errors.length > 0) {
                // Error - track it and move to next book
                processedBooks.errors.push({
                    id: bookId,
                    title: currentBook.title,
                    error: data.errors[0].error
                });
                currentBookIndex++;
                showCurrentBook();
            } else {
                // Unknown response - treat as error
                processedBooks.errors.push({
                    id: bookId,
                    title: currentBook.title,
                    error: 'Unknown response from server'
                });
                currentBookIndex++;
                showCurrentBook();
            }
        })
        .catch(error => {
            // Network or other error - track it and move to next book
            processedBooks.errors.push({
                id: bookId,
                title: currentBook.title,
                error: error.toString()
            });
            currentBookIndex++;
            showCurrentBook();
        });
    }

    function performBatchRename(bookIds) {
        // Mark remaining books as processed via batch
        const remainingBooks = renameQueue.slice(currentBookIndex);
        
        // Use existing batch rename functionality
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        bookIds.forEach(id => formData.append('selected_books', id));

        // Show progress modal and execute
        progressModal.show();
        document.getElementById('progressBar').className = 'progress-bar progress-bar-striped progress-bar-animated progress-bar-width-0';
        document.getElementById('progressText').textContent = 'Processing remaining books...';
        document.getElementById('progressResults').className = 'mt-3 d-hidden';
        document.getElementById('closeProgressBtn').className = 'btn btn-primary d-hidden';

        fetch('{% url "books:book_renamer_execute" %}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            // Track batch results
            if (data.success) {
                data.success.forEach(success => {
                    const book = remainingBooks.find(b => b.id == success.id);
                    if (book) {
                        processedBooks.success.push({
                            id: success.id,
                            title: book.title,
                            newPath: success.new_path
                        });
                    }
                });
            }
            
            if (data.errors) {
                data.errors.forEach(error => {
                    const book = remainingBooks.find(b => b.id == error.id);
                    if (book) {
                        processedBooks.errors.push({
                            id: error.id,
                            title: book.title,
                            error: error.error
                        });
                    }
                });
            }
            
            if (data.warnings) {
                data.warnings.forEach(warning => {
                    const book = remainingBooks.find(b => b.id == warning.id);
                    if (book) {
                        processedBooks.success.push({
                            id: warning.id,
                            title: book.title,
                            newPath: warning.new_path,
                            warnings: warning.warnings
                        });
                    }
                });
            }
            
            // Hide progress modal and show completion
            progressModal.hide();
            
            // Set current index to end to trigger completion
            currentBookIndex = renameQueue.length;
            
            // Show interactive modal again with completion summary
            showCompletionSummary();
            interactiveModal.show();
        })
        .catch(error => {
            // Mark all remaining as errors
            remainingBooks.forEach(book => {
                processedBooks.errors.push({
                    id: book.id,
                    title: book.title,
                    error: `Batch rename failed: ${error}`
                });
            });
            
            progressModal.hide();
            currentBookIndex = renameQueue.length;
            showCompletionSummary();
            interactiveModal.show();
        });
    }

    // Preview functionality with warnings check
    previewBtn.addEventListener('click', function() {
        const selectedBooks = Array.from(document.querySelectorAll('.book-checkbox:checked'))
            .map(cb => cb.value);
        
        if (selectedBooks.length === 0) {
            alert('Please select books to preview');
            return;
        }

        // Check for warnings in selected books
        let hasWarnings = false;
        const selectedRows = Array.from(document.querySelectorAll('.book-checkbox:checked'))
            .map(cb => cb.closest('tr'));
        
        selectedRows.forEach(row => {
            if (row.querySelector('.alert-warning, .alert-danger')) {
                hasWarnings = true;
            }
        });

        if (hasWarnings) {
            const proceed = confirm('Some selected books have warnings. Do you want to proceed with the preview?');
            if (!proceed) return;
        }

        // Show preview modal
        previewModal.show();
        
        // Make AJAX request for preview
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        selectedBooks.forEach(id => formData.append('selected_books', id));

        fetch('{% url "books:book_renamer_preview" %}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                document.getElementById('previewContent').innerHTML = 
                    `<div class="alert alert-danger">${data.error}</div>`;
            } else {
                displayPreview(data.preview);
            }
        })
        .catch(error => {
            document.getElementById('previewContent').innerHTML = 
                `<div class="alert alert-danger">Error loading preview: ${error}</div>`;
        });
    });

    // Display preview results
    function displayPreview(previewData) {
        let html = '<div class="table-responsive"><table class="table table-sm">';
        html += '<thead><tr><th class="rename-table-col-book">Book</th><th>Current Path</th><th>New Path</th><th class="rename-table-col-status">Status</th></tr></thead><tbody>';
        
        previewData.forEach(item => {
            const statusBadge = item.can_rename ? 
                '<span class="badge bg-success badge-xs">Ready</span>' : 
                '<span class="badge bg-danger badge-xs">Cannot Rename</span>';
                
            html += `<tr>
                <td>
                    <strong class="d-block rename-title-text">${item.title}</strong>
                    <small class="text-muted">${item.author}</small>
                </td>
                <td><small class="font-monospace text-break rename-path-text">${item.current_path}</small></td>
                <td><small class="font-monospace text-break text-primary rename-path-text">${item.new_path}</small></td>
                <td>${statusBadge}</td>
            </tr>`;
        });
        
        html += '</tbody></table></div>';
        document.getElementById('previewContent').innerHTML = html;
    }

    // Execute from preview modal
    document.getElementById('confirmExecuteBtn').addEventListener('click', function() {
        previewModal.hide();
        executeRename();
    });

    // Execute functionality
    executeBtn.addEventListener('click', function() {
        if (confirm('Are you sure you want to organize the selected files? This will move files to new locations.')) {
            executeRename();
        }
    });

    function executeRename() {
        const selectedBooks = Array.from(document.querySelectorAll('.book-checkbox:checked'))
            .map(cb => cb.value);
        
        if (selectedBooks.length === 0) {
            alert('Please select books to organize');
            return;
        }

        // Show progress modal
        progressModal.show();
        document.getElementById('progressBar').className = 'progress-bar progress-bar-striped progress-bar-animated progress-bar-width-0';
        document.getElementById('progressText').textContent = 'Starting file organization...';
        document.getElementById('progressResults').className = 'mt-3 d-hidden';
        document.getElementById('closeProgressBtn').className = 'btn btn-primary d-hidden';

        // Make AJAX request for execution
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        selectedBooks.forEach(id => formData.append('selected_books', id));

        fetch('{% url "books:book_renamer_execute" %}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById('progressBar').className = 'progress-bar progress-bar-width-100';
            document.getElementById('progressText').textContent = 'File organization completed!';
            
            document.getElementById('successCount').textContent = data.success.length;
            document.getElementById('warningCount').textContent = data.warnings ? data.warnings.length : 0;
            document.getElementById('errorCount').textContent = data.errors.length;
            document.getElementById('progressResults').className = 'mt-3 d-block';
            document.getElementById('closeProgressBtn').className = 'btn btn-primary d-inline-block';
            
            // Show revert option if there were successful operations
            if (data.success.length > 0 || (data.warnings && data.warnings.length > 0)) {
                document.getElementById('revertSection').className = 'mt-3 d-block';
                
                // Store batch ID for reversal
                window.lastBatchId = data.batch_id;
                
                // Set up revert button
                document.getElementById('revertBtn').addEventListener('click', function() {
                    if (confirm('Are you sure you want to revert all changes? This will move files back to their original locations.')) {
                        revertChanges(data.batch_id);
                    }
                });
            }
            
            // Show detailed results
            if (data.errors.length > 0) {
                let errorDetails = '<div class="mt-3"><h6>Errors:</h6><ul>';
                data.errors.forEach(error => {
                    errorDetails += `<li>${error.title}: ${error.error}</li>`;
                });
                errorDetails += '</ul></div>';
                document.getElementById('progressResults').innerHTML += errorDetails;
            }
            
            if (data.warnings && data.warnings.length > 0) {
                let warningDetails = '<div class="mt-3"><h6>Completed with Warnings:</h6><ul>';
                data.warnings.forEach(warning => {
                    warningDetails += `<li>${warning.title}: ${warning.warnings.join(', ')}</li>`;
                });
                warningDetails += '</ul></div>';
                document.getElementById('progressResults').innerHTML += warningDetails;
            }
            
            // Refresh page after closing modal
            document.getElementById('closeProgressBtn').addEventListener('click', function() {
                window.location.reload();
            });
        })
        .catch(error => {
            document.getElementById('progressBar').className = 'progress-bar progress-bar-width-100 bg-danger';
            document.getElementById('progressText').textContent = 'Error during file organization';
            document.getElementById('closeProgressBtn').className = 'btn btn-primary d-inline-block';
        });
    }

    // Initial button state
    updateButtonStates();
    
    // Revert changes function
    function revertChanges(batchId) {
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        formData.append('batch_id', batchId);
        
        // Hide revert button and show progress
        document.getElementById('revertBtn').disabled = true;
        document.getElementById('revertBtn').innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Reverting...';
        
        fetch('{% url "books:book_renamer_revert" %}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.errors.length === 0) {
                alert(`Successfully reverted ${data.success.length} operations.`);
                window.location.reload();
            } else {
                alert(`Revert completed with ${data.success.length} successes and ${data.errors.length} errors.`);
                console.log('Revert errors:', data.errors);
            }
        })
        .catch(error => {
            alert('Error reverting changes: ' + error);
            document.getElementById('revertBtn').disabled = false;
            document.getElementById('revertBtn').innerHTML = '<i class="fas fa-undo me-1"></i>Revert All Changes';
        });
    }
});
</script>
{% endblock %}
